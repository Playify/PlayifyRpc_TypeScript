"use strict";const input=document.querySelector("input"),autocomplete=document.querySelector("#autocomplete"),result=document.querySelector("#result"),copy=document.querySelector("#copy");function setStatus(e,t,n,l){const r=new Date(l-new Date().getTimezoneOffset()*1e3*60).toJSON(),s=document.querySelector("#status");s.textContent=`${e} (${r.replace("T"," ").replace("Z","")})`,s.style.color=t,s.style.backgroundColor=n}let curr=0;async function runEval(e=()=>Rpc.evalString(input.value)){for(;autocomplete.firstChild;)autocomplete.removeChild(autocomplete.lastChild);last="";const t=++curr,n=Date.now();try{setStatus("Executing","cyan","blue",n),result.style.backgroundColor="rgba(0,0,255,10%)",result.style.setProperty("scrollbar-color","rgb(0,0,128) transparent");const l=await e();if(t!=curr)return;result.textContent=l,result.style.backgroundColor="rgba(0,255,0,10%)",result.style.setProperty("scrollbar-color","rgb(0,128,0) transparent");const r=Date.now();setStatus(`Success (${((r-n)/1e3).toFixed(3)}s)`,"lime","green",Date.now())}catch(l){if(t!=curr)return;result.textContent=l.trashLocalStack()+`


Exception data:`+JSON.stringify(l.data,null,"	"),result.style.backgroundColor="rgba(255,0,0,10%)",result.style.setProperty("scrollbar-color","rgb(128,0,0) transparent");const r=Date.now();setStatus(`Failed (${((r-n)/1e3).toFixed(3)}s)`,"orangered","darkred",Date.now())}}let copyTimeout;copy.addEventListener("click",()=>{const e=document.createElement("textarea");e.value=result.textContent,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),copy.style.color="lime",copy.style.backgroundColor="darkgreen",clearTimeout(copyTimeout),copyTimeout=setTimeout(()=>{copy.style.color=null,copy.style.backgroundColor=null},250)}),document.querySelector("#execute").addEventListener("click",()=>runEval()),input.setSelectionRange(input.value.length,input.value.length),input.addEventListener("keydown",async e=>{let t;switch(e.key){case"ArrowUp":e.preventDefault(),t=autocomplete.querySelector(":scope>.active");{const n=[...autocomplete.querySelectorAll(":scope>.selectable")],l=n.indexOf(t);l==-1?n[n.length-1]?.classList.add("active"):(t?.classList.remove("active"),(n[l-1]??t)?.classList.add("active"))}break;case"ArrowDown":e.preventDefault(),t=autocomplete.querySelector(":scope>.active");{const n=[...autocomplete.querySelectorAll(":scope>.selectable")],l=n.indexOf(t);l==-1?n[0]?.classList.add("active"):(t?.classList.remove("active"),(n[l+1]??t)?.classList.add("active"))}break;case"Tab":e.preventDefault(),t=autocomplete.querySelector(":scope>.active.selectable")??autocomplete.querySelector(":scope>.selectable"),t?.onclick(null);return;case"Enter":e.preventDefault(),t=autocomplete.querySelector(":scope>.active"),t?t.onclick?.(null):runEval().catch(console.error);return;case"Escape":for(e.preventDefault();autocomplete.firstChild;)autocomplete.removeChild(autocomplete.lastChild);last="";return;case" ":case"Space":return e.altKey||e.shiftKey||e.ctrlKey?(e.preventDefault(),updateAutoComplete()):void 0;default:return}}),input.addEventListener("input",updateAutoComplete),input.addEventListener("selectionchange",updateAutoComplete),document.addEventListener("selectionchange",updateAutoComplete);let last;async function updateAutoComplete(){const e=input.parentElement.matches(":focus-within")?input.selectionStart+"|"+input.selectionEnd+"|"+input.value:"";if(e==last)return;last=e;let t=e?await getAutoComplete():[];for(;autocomplete.firstChild;)autocomplete.removeChild(autocomplete.lastChild);autocomplete.append(...t)}async function getAutoComplete(){let e=input.selectionStart??1/0,t=input.selectionEnd??1/0;e>t&&([e,t]=[t,e]);const n=input.value;let l=n.indexOf("(");if(l==-1)l=n.length;else if(t>l)return e<=l?[]:n.endsWith(")")&&t==n.length?[]:await getAutoCompleteParameters(n,l+1,n.endsWith(")")?n.length-1:n.length,e,t);let r=n.lastIndexOf(".",l);return r==-1||t<=r?await getAutoCompleteTypes(n,r,e):e>r?await getAutoCompleteMethods(n,r,l,e):[]}let cachedTypes=null,cachedTypesTimeout;async function getAutoCompleteTypes(e,t,n){cachedTypes??=Rpc.getAllTypes().finally(()=>console.log("Catching types")),clearTimeout(cachedTypesTimeout),cachedTypesTimeout=setTimeout(()=>cachedTypes=null,1e3);let l;try{l=await cachedTypes}catch(s){const c=document.createElement("div");return c.textContent="Error getting types: "+s.message,c.style.backgroundColor="rgba(255,0,0,10%)",[c]}const r=e.substring(0,n);return r[0]!="$"&&(l=l.filter(s=>s[0]!="$")),l.filter(s=>s.startsWith(r)).map(s=>{const c=document.createElement("div"),o=c.appendChild(document.createElement("i"));return o.appendChild(document.createTextNode(r)),o.appendChild(document.createElement("b")).textContent=s.substring(r.length),c.appendChild(document.createTextNode(t!=-1?e.substring(t):".")),c.onclick=()=>{input.focus(),document.execCommand("selectAll",!1,null),document.execCommand("insertText",!1,c.textContent??""),input.selectionStart=input.selectionEnd=s.length+1},c.classList.add("selectable"),c})}let cachedMethodsType=null,cachedMethods=null,cachedMethodsTimeout;async function getAutoCompleteMethods(e,t,n,l){const r=e.substring(0,t);cachedMethodsType!=r&&(cachedMethodsType=r,cachedMethods=null),cachedMethods??=Rpc.createObject(r)[RpcObjectGetMethods]().finally(()=>console.log("Catching methods for "+r)),clearTimeout(cachedMethodsTimeout),cachedMethodsTimeout=setTimeout(()=>cachedMethods=null,1e3);let s;try{s=await cachedMethods}catch(o){const i=document.createElement("div");return i.textContent="Error getting methods: "+o.message,i.style.backgroundColor="rgba(255,0,0,10%)",[i]}const c=e.substring(t+1,l);return s.filter(o=>o.toLowerCase().startsWith(c.toLowerCase())).map(o=>{const i=document.createElement("div");i.appendChild(document.createTextNode(r+"."));const a=i.appendChild(document.createElement("i"));return a.appendChild(document.createTextNode(o.substring(0,c.length))),a.appendChild(document.createElement("b")).textContent=o.substring(c.length),i.appendChild(document.createTextNode(e.length<=n?"(...)":e.substring(n))),i.onclick=()=>{input.focus(),document.execCommand("selectAll",!1,null),document.execCommand("insertText",!1,r+"."+o+(e.length<=n?"()":e.substring(n))),input.selectionStart=input.selectionEnd=r.length+o.length+2},i.classList.add("selectable"),i})}let cachedSignaturesMethod=null,cachedSignatures=null,cachedSignaturesTimeout;async function getAutoCompleteParameters(e,t,n,l,r){const s=e.substring(0,t-1);cachedSignaturesMethod!=s&&(cachedSignaturesMethod=s,cachedSignatures=null);const c=s.lastIndexOf(".");if(c==-1){const a=document.createElement("div");return a.textContent=`Error getting signatures: "${s}" is not in the form of type.method`,a.style.backgroundColor="rgba(255,0,0,10%)",[a]}cachedSignatures??=Rpc.createFunction(s.substring(0,c),s.substring(c+1)).getMethodSignatures().finally(()=>console.log("Catching signatures for "+s)),clearTimeout(cachedSignaturesTimeout),cachedSignaturesTimeout=setTimeout(()=>cachedSignatures=null,1e3);let o;try{o=await cachedSignatures}catch(a){const m=document.createElement("div");return m.textContent="Error getting signatures: "+a.message,m.style.backgroundColor="rgba(255,0,0,10%)",[m]}const i=splitArguments(e.substring(t,n));for(let[a,m,h]of i)if(l>=a+t&&r<=m+t)return o.map(([u,y])=>{const g=document.createElement("div"),d=checkArgs(i,u)?g.appendChild(document.createElement("b")):g;d.appendChild(document.createTextNode(e.substring(0,t)));let p=0;for(let f of u){if(p!=0&&d.appendChild(document.createTextNode(",")),h==p||h>=u.length&&(u[u.length-1].startsWith("params ")||u[u.length-1].startsWith("..."))){const b=d.appendChild(document.createElement("i"));b.textContent=f}else d.appendChild(document.createTextNode(f));p++}return d.appendChild(document.createTextNode(") \u21D2 ")),d.appendChild(document.createTextNode(y)),g});return[]}function splitArguments(e){let t=0,n=[],l=0,r=0;for(;r<e.length;r++){const s=e[r];if("({[".includes(s))t++;else if(")]}".includes(s))t--;else if(s==","&&t==0)n.push([l,r,n.length]);else if(s=='"'){for(r++;r<e.length&&e[r]!='"';r++)if(e[r]=="\\")switch(e[r+1]){case"u":r+=5;break;case"x":r+=3;break;default:r+=1;break}}}return r>e.length&&(r=e.length),n.push([l,r,n.length]),n}function checkArgs(e,t){const n=e.length==1&&e[0][0]===e[0][1]?0:e.length;if(n==t.length)return!0;if(t.length==0)return!1;const l=t[t.length-1];return!!((l.startsWith("params ")||l.startsWith("..."))&&n>=t.length-1)}
