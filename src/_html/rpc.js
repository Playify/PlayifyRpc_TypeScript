"use strict";const input=document.querySelector("input"),autocomplete=document.querySelector("#autocomplete"),result=document.querySelector("#result"),copy=document.querySelector("#copy");function setStatus(e,t,n,l){const c=new Date(l-new Date().getTimezoneOffset()*1e3*60).toJSON(),r=document.querySelector("#status");r.textContent=`${e} (${c.replace("T"," ").replace("Z","")})`,r.style.color=t,r.style.backgroundColor=n}let curr=0;async function runEval(e=()=>Rpc.evalString(input.value)){for(;autocomplete.firstChild;)autocomplete.removeChild(autocomplete.lastChild);last="";const t=++curr,n=Date.now();try{setStatus("Executing","cyan","blue",n),result.style.backgroundColor="rgba(0,0,255,10%)";const l=await e();if(t!=curr)return;result.textContent=l,result.style.backgroundColor="rgba(0,255,0,10%)";const c=Date.now();setStatus(`Success (${((c-n)/1e3).toFixed(3)}s)`,"lime","green",Date.now())}catch(l){if(t!=curr)return;result.textContent=l.trashLocalStack()+`


Exception data:`+JSON.stringify(l.data,null,"	"),result.style.backgroundColor="rgba(255,0,0,10%)";const c=Date.now();setStatus(`Failed (${((c-n)/1e3).toFixed(3)}s)`,"orangered","darkred",Date.now())}}let copyTimeout;copy.addEventListener("click",()=>{const e=document.createElement("textarea");e.value=result.textContent,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),copy.style.color="lime",copy.style.backgroundColor="darkgreen",clearTimeout(copyTimeout),copyTimeout=setTimeout(()=>{copy.style.color=null,copy.style.backgroundColor=null},250)}),document.querySelector("#execute").addEventListener("click",()=>runEval()),input.addEventListener("keydown",async e=>{let t;switch(e.key){case"ArrowUp":e.preventDefault(),t=autocomplete.querySelector(":scope>.active"),t?(t.classList.remove("active"),(t=t.previousElementSibling??t).classList.add("active")):(t=autocomplete.lastElementChild)?.classList.add("active");break;case"ArrowDown":e.preventDefault(),t=autocomplete.querySelector(":scope>.active"),t?(t.classList.remove("active"),(t=t.nextElementSibling??t).classList.add("active")):(t=autocomplete.firstElementChild)?.classList.add("active");break;case"Tab":e.preventDefault(),t=autocomplete.querySelector(":scope>.active,:scope>:only-child"),t?.onclick(null);return;case"Enter":e.preventDefault(),t=autocomplete.querySelector(":scope>.active"),t?t.onclick(null):runEval().catch(console.error);return;case"Escape":for(e.preventDefault();autocomplete.firstChild;)autocomplete.removeChild(autocomplete.lastChild);last="";return;case" ":case"Space":(e.altKey||e.shiftKey||e.ctrlKey)&&(updateAutoComplete(),e.preventDefault());return;default:return}}),input.addEventListener("input",updateAutoComplete),input.addEventListener("selectionchange",updateAutoComplete),document.addEventListener("selectionchange",updateAutoComplete);let last;async function updateAutoComplete(){const e=input.parentElement.matches(":focus-within")?input.selectionStart+"|"+input.selectionEnd+"|"+input.value:"";if(e==last)return;last=e;let t=e?await getAutoComplete():[];for(;autocomplete.firstChild;)autocomplete.removeChild(autocomplete.lastChild);autocomplete.append(...t)}let cachedTypes=null,cachedTypesTimeout,cachedMethodsType=null,cachedMethods=null,cachedMethodsTimeout;async function getAutoComplete(){let e=input.selectionStart??1/0,t=input.selectionEnd??1/0;e>t&&([e,t]=[t,e]);const n=input.value;let l=n.indexOf("(");if(l==-1)l=n.length;else if(t>l)return[];let c=n.lastIndexOf(".",l);if(c==-1||t<=c){cachedTypes??=Rpc.getAllTypes().finally(()=>console.log("Catching types")),clearTimeout(cachedTypesTimeout),cachedTypesTimeout=setTimeout(()=>cachedTypes=null,1e3);let r;try{r=await cachedTypes}catch(s){const o=document.createElement("div");return o.textContent="Error getting types: "+s.message,[o]}const d=n.substring(0,e);return d[0]!="$"&&(r=r.filter(s=>s[0]!="$")),r.filter(s=>s.startsWith(d)).map(s=>{const o=document.createElement("div"),a=o.appendChild(document.createElement("i"));return a.appendChild(document.createTextNode(d)),a.appendChild(document.createElement("b")).textContent=s.substring(d.length),o.appendChild(document.createTextNode(c!=-1?n.substring(c):".")),o.onclick=()=>{input.focus(),document.execCommand("selectAll",!1,null),document.execCommand("insertText",!1,o.textContent??""),input.selectionStart=input.selectionEnd=s.length+1},o})}else if(e>c){const r=n.substring(0,c);cachedMethodsType!=r&&(cachedMethodsType=r,cachedMethods=null);const d=cachedMethodsType;cachedMethods??=Rpc.createObject(cachedMethodsType)[RpcObjectGetMethods]().finally(()=>console.log("Catching methods for "+d)),clearTimeout(cachedMethodsTimeout),cachedMethodsTimeout=setTimeout(()=>cachedMethods=null,1e3);let s;try{s=await cachedMethods}catch(a){const i=document.createElement("div");return i.textContent="Error getting methods: "+a.message,i.style.backgroundColor="rgba(255,0,0,10%)",[i]}const o=n.substring(c+1,e);return s.filter(a=>a.toLowerCase().startsWith(o.toLowerCase())).map(a=>{const i=document.createElement("div");i.appendChild(document.createTextNode(d+"."));const u=i.appendChild(document.createElement("i"));return u.appendChild(document.createTextNode(a.substring(0,o.length))),u.appendChild(document.createElement("b")).textContent=a.substring(o.length),i.appendChild(document.createTextNode(n.length<=l?"()":n.substring(l))),i.onclick=()=>{input.focus(),document.execCommand("selectAll",!1,null),document.execCommand("insertText",!1,i.textContent??""),input.selectionStart=input.selectionEnd=d.length+a.length+2},i})}else return[]}
