{"version":3,"file":"rpc.js","sources":["../src/types/errors/RpcCustomErrorDecorator.ts","../node_modules/stackframe/stackframe.js","../node_modules/error-stack-parser/error-stack-parser.js","../src/types/RpcError.ts","../src/connection/RpcId.ts","../src/types/errors/PredefinedErrors.ts","../src/internal/functionParameterNames.ts","../src/internal/RegisteredTypes.ts","../src/types/functions/PendingCall.ts","../src/types/functions/FunctionCallContext.ts","../src/types/RpcFunction.ts","../src/types/RpcObject.ts","../src/types/data/DynamicData.ts","../src/types/data/DataOutput.ts","../src/connection/Connection.ts","../src/types/data/DataInput.ts","../src/connection/WebSocketConnection.ts","../src/connection/RpcName.ts","../src/types/data/CustomDynamicTypeDecorator.ts","../src/types/RpcProviderDecorator.ts","../src/rpc.ts"],"sourcesContent":["import {RpcError} from \"../RpcError.js\";\r\n\r\nexport const RpcCustomErrors:[\r\n\tMap<string,typeof RpcError>,\r\n\tMap<typeof RpcError,string>\r\n]=[new Map,new Map];\r\nexport function RpcCustomError(typeTag: string){\r\n\treturn function(target: typeof RpcError){\r\n\t\tconst [tagToError,errorToTag]=RpcCustomErrors;\r\n\t\ttagToError.set(typeTag,target);\r\n\t\terrorToTag.set(target,typeTag);\r\n\t};\r\n}","(function(root, factory) {\n    'use strict';\n    // Universal Module Definition (UMD) to support AMD, CommonJS/Node.js, Rhino, and browsers.\n\n    /* istanbul ignore next */\n    if (typeof define === 'function' && define.amd) {\n        define('stackframe', [], factory);\n    } else if (typeof exports === 'object') {\n        module.exports = factory();\n    } else {\n        root.StackFrame = factory();\n    }\n}(this, function() {\n    'use strict';\n    function _isNumber(n) {\n        return !isNaN(parseFloat(n)) && isFinite(n);\n    }\n\n    function _capitalize(str) {\n        return str.charAt(0).toUpperCase() + str.substring(1);\n    }\n\n    function _getter(p) {\n        return function() {\n            return this[p];\n        };\n    }\n\n    var booleanProps = ['isConstructor', 'isEval', 'isNative', 'isToplevel'];\n    var numericProps = ['columnNumber', 'lineNumber'];\n    var stringProps = ['fileName', 'functionName', 'source'];\n    var arrayProps = ['args'];\n    var objectProps = ['evalOrigin'];\n\n    var props = booleanProps.concat(numericProps, stringProps, arrayProps, objectProps);\n\n    function StackFrame(obj) {\n        if (!obj) return;\n        for (var i = 0; i < props.length; i++) {\n            if (obj[props[i]] !== undefined) {\n                this['set' + _capitalize(props[i])](obj[props[i]]);\n            }\n        }\n    }\n\n    StackFrame.prototype = {\n        getArgs: function() {\n            return this.args;\n        },\n        setArgs: function(v) {\n            if (Object.prototype.toString.call(v) !== '[object Array]') {\n                throw new TypeError('Args must be an Array');\n            }\n            this.args = v;\n        },\n\n        getEvalOrigin: function() {\n            return this.evalOrigin;\n        },\n        setEvalOrigin: function(v) {\n            if (v instanceof StackFrame) {\n                this.evalOrigin = v;\n            } else if (v instanceof Object) {\n                this.evalOrigin = new StackFrame(v);\n            } else {\n                throw new TypeError('Eval Origin must be an Object or StackFrame');\n            }\n        },\n\n        toString: function() {\n            var fileName = this.getFileName() || '';\n            var lineNumber = this.getLineNumber() || '';\n            var columnNumber = this.getColumnNumber() || '';\n            var functionName = this.getFunctionName() || '';\n            if (this.getIsEval()) {\n                if (fileName) {\n                    return '[eval] (' + fileName + ':' + lineNumber + ':' + columnNumber + ')';\n                }\n                return '[eval]:' + lineNumber + ':' + columnNumber;\n            }\n            if (functionName) {\n                return functionName + ' (' + fileName + ':' + lineNumber + ':' + columnNumber + ')';\n            }\n            return fileName + ':' + lineNumber + ':' + columnNumber;\n        }\n    };\n\n    StackFrame.fromString = function StackFrame$$fromString(str) {\n        var argsStartIndex = str.indexOf('(');\n        var argsEndIndex = str.lastIndexOf(')');\n\n        var functionName = str.substring(0, argsStartIndex);\n        var args = str.substring(argsStartIndex + 1, argsEndIndex).split(',');\n        var locationString = str.substring(argsEndIndex + 1);\n\n        if (locationString.indexOf('@') === 0) {\n            var parts = /@(.+?)(?::(\\d+))?(?::(\\d+))?$/.exec(locationString, '');\n            var fileName = parts[1];\n            var lineNumber = parts[2];\n            var columnNumber = parts[3];\n        }\n\n        return new StackFrame({\n            functionName: functionName,\n            args: args || undefined,\n            fileName: fileName,\n            lineNumber: lineNumber || undefined,\n            columnNumber: columnNumber || undefined\n        });\n    };\n\n    for (var i = 0; i < booleanProps.length; i++) {\n        StackFrame.prototype['get' + _capitalize(booleanProps[i])] = _getter(booleanProps[i]);\n        StackFrame.prototype['set' + _capitalize(booleanProps[i])] = (function(p) {\n            return function(v) {\n                this[p] = Boolean(v);\n            };\n        })(booleanProps[i]);\n    }\n\n    for (var j = 0; j < numericProps.length; j++) {\n        StackFrame.prototype['get' + _capitalize(numericProps[j])] = _getter(numericProps[j]);\n        StackFrame.prototype['set' + _capitalize(numericProps[j])] = (function(p) {\n            return function(v) {\n                if (!_isNumber(v)) {\n                    throw new TypeError(p + ' must be a Number');\n                }\n                this[p] = Number(v);\n            };\n        })(numericProps[j]);\n    }\n\n    for (var k = 0; k < stringProps.length; k++) {\n        StackFrame.prototype['get' + _capitalize(stringProps[k])] = _getter(stringProps[k]);\n        StackFrame.prototype['set' + _capitalize(stringProps[k])] = (function(p) {\n            return function(v) {\n                this[p] = String(v);\n            };\n        })(stringProps[k]);\n    }\n\n    return StackFrame;\n}));\n","(function(root, factory) {\n    'use strict';\n    // Universal Module Definition (UMD) to support AMD, CommonJS/Node.js, Rhino, and browsers.\n\n    /* istanbul ignore next */\n    if (typeof define === 'function' && define.amd) {\n        define('error-stack-parser', ['stackframe'], factory);\n    } else if (typeof exports === 'object') {\n        module.exports = factory(require('stackframe'));\n    } else {\n        root.ErrorStackParser = factory(root.StackFrame);\n    }\n}(this, function ErrorStackParser(StackFrame) {\n    'use strict';\n\n    var FIREFOX_SAFARI_STACK_REGEXP = /(^|@)\\S+:\\d+/;\n    var CHROME_IE_STACK_REGEXP = /^\\s*at .*(\\S+:\\d+|\\(native\\))/m;\n    var SAFARI_NATIVE_CODE_REGEXP = /^(eval@)?(\\[native code])?$/;\n\n    return {\n        /**\n         * Given an Error object, extract the most information from it.\n         *\n         * @param {Error} error object\n         * @return {Array} of StackFrames\n         */\n        parse: function ErrorStackParser$$parse(error) {\n            if (typeof error.stacktrace !== 'undefined' || typeof error['opera#sourceloc'] !== 'undefined') {\n                return this.parseOpera(error);\n            } else if (error.stack && error.stack.match(CHROME_IE_STACK_REGEXP)) {\n                return this.parseV8OrIE(error);\n            } else if (error.stack) {\n                return this.parseFFOrSafari(error);\n            } else {\n                throw new Error('Cannot parse given Error object');\n            }\n        },\n\n        // Separate line and column numbers from a string of the form: (URI:Line:Column)\n        extractLocation: function ErrorStackParser$$extractLocation(urlLike) {\n            // Fail-fast but return locations like \"(native)\"\n            if (urlLike.indexOf(':') === -1) {\n                return [urlLike];\n            }\n\n            var regExp = /(.+?)(?::(\\d+))?(?::(\\d+))?$/;\n            var parts = regExp.exec(urlLike.replace(/[()]/g, ''));\n            return [parts[1], parts[2] || undefined, parts[3] || undefined];\n        },\n\n        parseV8OrIE: function ErrorStackParser$$parseV8OrIE(error) {\n            var filtered = error.stack.split('\\n').filter(function(line) {\n                return !!line.match(CHROME_IE_STACK_REGEXP);\n            }, this);\n\n            return filtered.map(function(line) {\n                if (line.indexOf('(eval ') > -1) {\n                    // Throw away eval information until we implement stacktrace.js/stackframe#8\n                    line = line.replace(/eval code/g, 'eval').replace(/(\\(eval at [^()]*)|(,.*$)/g, '');\n                }\n                var sanitizedLine = line.replace(/^\\s+/, '').replace(/\\(eval code/g, '(').replace(/^.*?\\s+/, '');\n\n                // capture and preseve the parenthesized location \"(/foo/my bar.js:12:87)\" in\n                // case it has spaces in it, as the string is split on \\s+ later on\n                var location = sanitizedLine.match(/ (\\(.+\\)$)/);\n\n                // remove the parenthesized location from the line, if it was matched\n                sanitizedLine = location ? sanitizedLine.replace(location[0], '') : sanitizedLine;\n\n                // if a location was matched, pass it to extractLocation() otherwise pass all sanitizedLine\n                // because this line doesn't have function name\n                var locationParts = this.extractLocation(location ? location[1] : sanitizedLine);\n                var functionName = location && sanitizedLine || undefined;\n                var fileName = ['eval', '<anonymous>'].indexOf(locationParts[0]) > -1 ? undefined : locationParts[0];\n\n                return new StackFrame({\n                    functionName: functionName,\n                    fileName: fileName,\n                    lineNumber: locationParts[1],\n                    columnNumber: locationParts[2],\n                    source: line\n                });\n            }, this);\n        },\n\n        parseFFOrSafari: function ErrorStackParser$$parseFFOrSafari(error) {\n            var filtered = error.stack.split('\\n').filter(function(line) {\n                return !line.match(SAFARI_NATIVE_CODE_REGEXP);\n            }, this);\n\n            return filtered.map(function(line) {\n                // Throw away eval information until we implement stacktrace.js/stackframe#8\n                if (line.indexOf(' > eval') > -1) {\n                    line = line.replace(/ line (\\d+)(?: > eval line \\d+)* > eval:\\d+:\\d+/g, ':$1');\n                }\n\n                if (line.indexOf('@') === -1 && line.indexOf(':') === -1) {\n                    // Safari eval frames only have function names and nothing else\n                    return new StackFrame({\n                        functionName: line\n                    });\n                } else {\n                    var functionNameRegex = /((.*\".+\"[^@]*)?[^@]*)(?:@)/;\n                    var matches = line.match(functionNameRegex);\n                    var functionName = matches && matches[1] ? matches[1] : undefined;\n                    var locationParts = this.extractLocation(line.replace(functionNameRegex, ''));\n\n                    return new StackFrame({\n                        functionName: functionName,\n                        fileName: locationParts[0],\n                        lineNumber: locationParts[1],\n                        columnNumber: locationParts[2],\n                        source: line\n                    });\n                }\n            }, this);\n        },\n\n        parseOpera: function ErrorStackParser$$parseOpera(e) {\n            if (!e.stacktrace || (e.message.indexOf('\\n') > -1 &&\n                e.message.split('\\n').length > e.stacktrace.split('\\n').length)) {\n                return this.parseOpera9(e);\n            } else if (!e.stack) {\n                return this.parseOpera10(e);\n            } else {\n                return this.parseOpera11(e);\n            }\n        },\n\n        parseOpera9: function ErrorStackParser$$parseOpera9(e) {\n            var lineRE = /Line (\\d+).*script (?:in )?(\\S+)/i;\n            var lines = e.message.split('\\n');\n            var result = [];\n\n            for (var i = 2, len = lines.length; i < len; i += 2) {\n                var match = lineRE.exec(lines[i]);\n                if (match) {\n                    result.push(new StackFrame({\n                        fileName: match[2],\n                        lineNumber: match[1],\n                        source: lines[i]\n                    }));\n                }\n            }\n\n            return result;\n        },\n\n        parseOpera10: function ErrorStackParser$$parseOpera10(e) {\n            var lineRE = /Line (\\d+).*script (?:in )?(\\S+)(?:: In function (\\S+))?$/i;\n            var lines = e.stacktrace.split('\\n');\n            var result = [];\n\n            for (var i = 0, len = lines.length; i < len; i += 2) {\n                var match = lineRE.exec(lines[i]);\n                if (match) {\n                    result.push(\n                        new StackFrame({\n                            functionName: match[3] || undefined,\n                            fileName: match[2],\n                            lineNumber: match[1],\n                            source: lines[i]\n                        })\n                    );\n                }\n            }\n\n            return result;\n        },\n\n        // Opera 10.65+ Error.stack very similar to FF/Safari\n        parseOpera11: function ErrorStackParser$$parseOpera11(error) {\n            var filtered = error.stack.split('\\n').filter(function(line) {\n                return !!line.match(FIREFOX_SAFARI_STACK_REGEXP) && !line.match(/^Error created at/);\n            }, this);\n\n            return filtered.map(function(line) {\n                var tokens = line.split('@');\n                var locationParts = this.extractLocation(tokens.pop());\n                var functionCall = (tokens.shift() || '');\n                var functionName = functionCall\n                    .replace(/<anonymous function(: (\\w+))?>/, '$2')\n                    .replace(/\\([^)]*\\)/g, '') || undefined;\n                var argsRaw;\n                if (functionCall.match(/\\(([^)]*)\\)/)) {\n                    argsRaw = functionCall.replace(/^[^(]+\\(([^)]*)\\)$/, '$1');\n                }\n                var args = (argsRaw === undefined || argsRaw === '[arguments not available]') ?\n                    undefined : argsRaw.split(',');\n\n                return new StackFrame({\n                    functionName: functionName,\n                    args: args,\n                    fileName: locationParts[0],\n                    lineNumber: locationParts[1],\n                    columnNumber: locationParts[2],\n                    source: line\n                });\n            }, this);\n        }\n    };\n}));\n","import {DataInput,DataOutput,Rpc} from \"../rpc.js\";\r\nimport {RpcCustomErrors} from \"./errors/RpcCustomErrorDecorator.js\";\r\nimport ErrorStackParser,{StackFrame} from \"error-stack-parser\";\r\n\r\nfunction fixString(s:string){\r\n\treturn s.replaceAll(\"\\r\",\"\")\r\n\t\t.replaceAll(/^\\n+|\\n+$/g,\"\")\r\n\t\t.replaceAll(/^  +/gm,\"\\t\");\r\n}\r\n\r\nfunction framesToString(frames:StackFrame[]):string{\r\n\tlet result=\"\";\r\n\tfor(let frame of frames)\r\n\t\tif(frame.functionName?.includes(\"$RPC_MARKER_BEGIN$\")) break;\r\n\t\telse result+=\"\\n\\tat \"+frame;\r\n\treturn result;\r\n}\r\n\r\nfunction causeToString(cause:unknown):string{\r\n\tif(cause===undefined) return \"\";\r\n\tif(cause instanceof RpcError) return \"\\ncaused by: \"+cause.toString();\r\n\tif(cause instanceof Error)\r\n\t\treturn \"\\ncaused by: \"+fixString(cause.toString())\r\n\t\t\t+framesToString(ErrorStackParser.parse(cause))\r\n\t\t\t+causeToString(cause.cause);\r\n\treturn \"\\ncaused by: \"+fixString(cause?.toString()??\"null\");\r\n}\r\n\r\n\r\n//Remove RpcError inheritance from stack trace\r\nfunction removeFromStackTrace(e:typeof RpcError & {__proto__:any},ownStack:StackFrame[]):boolean{\r\n\tif((e===RpcError||removeFromStackTrace(e.__proto__,ownStack))\r\n\t\t&&ownStack[0].functionName?.replace(/^new /,\"\")===e.name){\r\n\t\townStack.shift();\r\n\t\treturn true;\r\n\t}else return false;\r\n}\r\n\r\nexport class RpcError extends Error{\r\n\t//public get type(){return this.name}\r\n\r\n\tpublic readonly from:string;\r\n\tpublic readonly data:Record<string,any>={};\r\n\t#ownStack:StackFrame[]=[];\r\n\r\n\tpublic get stackTrace(){\r\n\t\tlet result=this.#stackTrace;\r\n\t\tresult+=framesToString(this.#ownStack);\r\n\t\tresult+=this.#causes;\r\n\t\treturn result.replaceAll(/^\\n+/g,\"\");\r\n\t}\r\n\r\n\t#stackTrace:string=\"\";\r\n\t#appendStack=false;\r\n\treadonly #causes:string=\"\";\r\n\r\n\tconstructor(message:string);\r\n\tconstructor(message:string,cause:Error | unknown);\r\n\tconstructor(type:string | null,from:string | null,message:string | null,stackTrace:string | null);\r\n\tconstructor(type:string | null,from:string | null,message:string | null,stackTrace:string | null,cause:Error);\r\n\tconstructor(type:string | null,from:string | null,message:string | null,stackTrace:string | null,data:Record<string,any>);\r\n\tconstructor(type:string | null,from:string | null,message:string | null,stackTrace:string | null,data:Record<string,any>,cause:Error | unknown);\r\n\tconstructor(...args:\r\n\t\t\t\t\t[message:string] |\r\n\t\t\t\t\t[message:string,cause:Error | unknown] |\r\n\t\t\t\t\t[type:string | null,from:string | null,message:string | null,stackTrace:string | null] |\r\n\t\t\t\t\t[type:string | null,from:string | null,message:string | null,stackTrace:string | null,cause:Error] |\r\n\t\t\t\t\t[type:string | null,from:string | null,message:string | null,stackTrace:string | null,data:Record<string,any>] |\r\n\t\t\t\t\t[type:string | null,from:string | null,message:string | null,stackTrace:string | null,data:Record<string,any>,cause:Error | unknown]\r\n\t){\r\n\t\tlet type:string | null=null;\r\n\t\tlet from:string | null=null;\r\n\t\tlet message:string | null=null;\r\n\t\tlet stackTrace:string | null=null;\r\n\t\tlet data:Record<string,any>={};\r\n\t\tlet cause:Error | unknown | undefined=undefined;\r\n\r\n\t\tswitch(args.length){\r\n\t\t\tcase 1:\r\n\t\t\t\t[message]=args;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 2:\r\n\t\t\t\t[message,cause]=args;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 4:\r\n\t\t\t\t[message,from,message,stackTrace]=args;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 5:\r\n\t\t\t\tif(args[4] instanceof RpcError) [message,from,message,stackTrace,cause]=args;\r\n\t\t\t\telse [message,from,message,stackTrace,data]=args;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 6:\r\n\t\t\t\t[message,from,message,stackTrace,data,cause]=args;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error(\"Invalid arg count\");\r\n\t\t}\r\n\r\n\t\tif(cause!=null) super(message??undefined,{cause});\r\n\t\telse super(message??undefined);\r\n\r\n\t\tthis.name=type??this.constructor.name;\r\n\t\tthis.from=from??Rpc.prettyName;\r\n\r\n\t\tconst typeTag=RpcCustomErrors[1].get(this.constructor as any);\r\n\t\tif(typeTag!=null) this.data[\"$type\"]=typeTag;\r\n\t\tObject.assign(this.data,data??{});\r\n\r\n\r\n\t\tif(stackTrace==null){\r\n\t\t\tthis.#appendStack=true;\r\n\t\t\tthis.#ownStack=ErrorStackParser.parse(this);\r\n\t\t\tremoveFromStackTrace(this.constructor as any,this.#ownStack);\r\n\t\t}else{\r\n\t\t\tthis.#stackTrace=\"\\n\"+fixString(stackTrace);\r\n\t\t\tconst causeIndex=this.#stackTrace.indexOf(\"\\ncaused by: \");\r\n\t\t\tif(causeIndex!= -1){\r\n\t\t\t\tthis.#causes+=this.#stackTrace.substring(causeIndex);\r\n\t\t\t\tthis.#stackTrace=this.#stackTrace.substring(0,causeIndex);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.#causes+=causeToString(cause);\r\n\r\n\t\tthis.stack=this.toString();\r\n\t}\r\n\r\n\ttoString(){\r\n\t\tlet s=this.name+\"(\"+this.from+\")\";\r\n\t\tif(this.message?.trim()) s+=\": \"+this.message;\r\n\r\n\t\tconst trace=this.stackTrace;\r\n\t\tif(trace?.trim()) s+=\"\\n\"+trace;\r\n\r\n\t\treturn s;\r\n\t}\r\n\r\n\twrite(output:DataOutput){\r\n\t\toutput.writeString(this.name);\r\n\t\toutput.writeString(this.from);\r\n\t\toutput.writeString(this.message);\r\n\t\toutput.writeString(this.stackTrace);\r\n\t\toutput.writeString(Object.keys(this.data).length==0?null:JSON.stringify(this.data));\r\n\t}\r\n\r\n\tstatic read(input:DataInput){\r\n\t\tconst type=input.readString();\r\n\t\tconst from=input.readString()??\"???\";\r\n\t\tconst message=input.readString();\r\n\t\tconst stackTrace=input.readString()??\"\";\r\n\r\n\t\tlet data;\r\n\t\ttry{\r\n\t\t\tdata=JSON.parse(input.readString()??\"null\");\r\n\t\t}catch(e){\r\n\t\t\tif(e instanceof RangeError)\r\n\t\t\t\tdata={\"$info\":\"JsonData was not included, due to an old PlayifyRpc version\"};\r\n\t\t\telse throw e;\r\n\t\t}\r\n\r\n\t\treturn RpcError.create(type,from,message,stackTrace,data);\r\n\t}\r\n\r\n\tstatic create(type:string | null,from:string,message:string | null,stackTrace:string,data:Record<string,any>){\r\n\t\tconst typeTag=data?.[\"$type\"];\r\n\t\tconst constructor:typeof RpcError=RpcCustomErrors[0].get(typeTag)??RpcError;\r\n\t\treturn new constructor(type,from,message,stackTrace,data);\r\n\t}\r\n\r\n\r\n\tstatic wrapAndFreeze(e:Error):RpcError{\r\n\t\tif(e instanceof RpcError){\r\n\t\t\tif(!e.#appendStack) return e;\r\n\t\t\te.#appendStack=false;\r\n\t\t\te.#stackTrace+=framesToString(e.#ownStack);\r\n\t\t\te.#ownStack=[];\r\n\t\t\te.stack=e.toString();\r\n\t\t\treturn e;\r\n\t\t}\r\n\r\n\t\treturn new RpcError(\r\n\t\t\te.name,\r\n\t\t\te instanceof RpcError?e.from:null,\r\n\t\t\te.message,\r\n\t\t\tframesToString(ErrorStackParser.parse(e)).substring(1),\r\n\t\t\t{},\r\n\t\t\te.cause as Error,\r\n\t\t);\r\n\t}\r\n\r\n\tunfreeze(stackSource:Error,skip:number){\r\n\t\tif(this.#appendStack) return this;\r\n\t\tthis.#appendStack=true;\r\n\t\tthis.#ownStack=ErrorStackParser.parse(stackSource).slice(skip);\r\n\t\tthis.stack=this.toString();\r\n\t\treturn this;\r\n\t}\r\n\t\r\n\ttrashLocalStack(){\r\n\t\tthis.#appendStack=false;\r\n\t\tthis.#ownStack=[];\r\n\t\tthis.stack=this.toString();\r\n\t\treturn this;\r\n\t}\r\n\r\n\tappend(type:string | null,method:string | null,args:any[] | null){\r\n\t\tthis.#stackTrace+=\"\\n\\trpc \"+(args==null\r\n\t\t\t?\"<<callLocal>>\"\r\n\t\t\t:(type??\"<<null>>\")+\".\"+(method??\"<<null>>\")+\"(\"+\r\n\t\t\targs.map(a=>JSON.stringify(a)).join(\",\")+\")\");\r\n\t\tthis.stack=this.toString();\r\n\t\treturn this;\r\n\t}\r\n}","export const isNodeJs=globalThis?.process?.versions?.node!=null;\r\n\r\nconst chars=\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\r\nexport const randomId=()=>Date.now().toString(36)+Array(10)\r\n\t.fill(undefined)\r\n\t.map(()=>chars[Math.floor(Math.random()*chars.length)])\r\n\t.join(\"\");\r\n\r\n\r\n//RpcId\r\nexport let RpcId:string;\r\nif(isNodeJs)\r\n\ttry{\r\n\t\tif(process?.versions.bun)\r\n\t\t\tRpcId=\"bun@\"+require(\"os\").hostname()+\"@\"+process.pid;\r\n\t\telse\r\n\t\t\t//@ts-ignore\r\n\t\t\t// noinspection JSUnresolvedReference\r\n\t\t\tRpcId=\"node@\"+process.binding(\"os\").getHostname()+\"@\"+process.pid;//Needed to not use top level await\r\n\t}catch{\r\n\t\tRpcId=\"node-alternative@\"+process.platform+\":\"+process.arch+\"@\"+process.pid;\r\n\t}\r\nelse if(\"document\" in globalThis) RpcId=\"web@\"+document.location+\"#\"+randomId();\r\nelse//Unknown Platform\r\n\tRpcId=\"js@\"+randomId();","import {RpcError} from \"../RpcError.js\";\r\nimport {RpcCustomError} from \"./RpcCustomErrorDecorator.js\";\r\n\r\nconst quoted=(s:string | null)=>s==null?\"null\":\"\\\"\"+s+\"\\\"\";\r\n\r\nexport abstract class RpcCallError extends RpcError{}\r\n\r\n@RpcCustomError(\"$type\")\r\nexport class RpcTypeNotFoundError extends RpcCallError{\r\n\tstatic new=(type:string | null)=>new RpcTypeNotFoundError(null,null,\r\n\t\t`Type ${quoted(type)} does not exist`,\"\",{type});\r\n}\r\n\r\n@RpcCustomError(\"$method\")\r\nexport class RpcMethodNotFoundError extends RpcCallError{\r\n\tstatic new=(type:string | null,method:string | null)=>new RpcMethodNotFoundError(null,null,\r\n\t\t`Method ${quoted(method)} does not exist on type ${quoted(type)}`,\"\",{type,method});\r\n}\r\n\r\n@RpcCustomError(\"$method-meta\")\r\nexport class RpcMetaMethodNotFoundError extends RpcMethodNotFoundError{\r\n\tstatic new=(type:string | null,meta:string | null)=>new RpcMetaMethodNotFoundError(null,null,\r\n\t\t`Meta-Method ${quoted(meta)} does not exist on type ${quoted(type)}`,\"\",{type,method:null,meta});\r\n}\r\n\r\n@RpcCustomError(\"$connection\")\r\nexport class RpcConnectionError extends RpcCallError{\r\n\tstatic new=(message:string | null)=>new RpcConnectionError(null,null,message,\"\");\r\n}\r\n\r\n@RpcCustomError(\"$eval\")\r\nexport class RpcEvalError extends RpcCallError{}\r\n\r\n@RpcCustomError(\"$data\")\r\nexport class RpcDataError extends RpcError{\r\n\tstatic new=(message:string,cause:Error)=>new RpcDataError(null,null,message,\"\",cause);\r\n}","export function getFunctionParameterNames(func:Function):string[]{\r\n\tlet code=func.toString();\r\n\tcode=code.substring(code.indexOf('(')+1);\r\n\r\n\tconst args:string[]=[];\r\n\twhile(true){\r\n\t\tconst s=identifier(code);\r\n\t\targs.push(s.replaceAll('\\0','').trim());\r\n\t\tcode=code.substring(s.length);\r\n\t\twhile(code[0]=='/') code=code.substring(identifier(code).length);\r\n\t\tif(code[0]=='=') code=code.substring(identifier(code.substring(1)).length+1);\r\n\t\twhile(code[0]=='/') code=code.substring(identifier(code).length);\r\n\t\tif(code[0]==')') break;\r\n\t\tif(code[0]==',') code=code.substring(1);\r\n\t\telse throw new Error(\"Invalid args\");\r\n\t}\r\n\r\n\treturn args;\r\n}\r\n\r\nexport function identifier(s:string):string{\r\n\tif(s[0]=='/'){\r\n\t\tif(s[1]=='/'){\r\n\t\t\tconst end=s.indexOf(\"\\n\");\r\n\t\t\tif(end==-1)return s;\r\n\t\t\telse return s.substring(0,end+1);\r\n\t\t}\r\n\t\tif(s[1]=='*'){\r\n\t\t\tconst end=s.indexOf(\"*/\",2);\r\n\t\t\tif(end==-1)return s;\r\n\t\t\telse return s.substring(0,end+2);\r\n\t\t}\r\n\t}\r\n\tif(s[0]=='['){\r\n\t\tlet result=\"[\";\r\n\t\twhile(true){\r\n\t\t\tresult+=identifier(s.substring(result.length));\r\n\t\t\tif(s[result.length]==']') return result+\"]\";\r\n\t\t\telse if(s[result.length]==',') result+=\",\";\r\n\t\t\telse if(s[result.length]=='/') continue;//identifier skips comments\r\n\t\t\telse if(s[result.length]=='=') result+=\"\\0\".repeat(identifier(s.substring(result.length+1)).length+1);\r\n\t\t\telse throw new Error(\"Invalid array destructuring\");\r\n\t\t}\r\n\t}\r\n\tif(s[0]=='{'){\r\n\t\tlet result=\"{\";\r\n\t\twhile(true){\r\n\t\t\tresult+=identifier(s.substring(result.length));\r\n\t\t\tif(s[result.length]=='}') return result+\"}\";\r\n\t\t\telse if(s[result.length]==':') result+=\":\";\r\n\t\t\telse if(s[result.length]==',') result+=\",\";\r\n\t\t\telse if(s[result.length]=='/') continue;//identifier skips comments\r\n\t\t\telse if(s[result.length]=='=') result+=\"\\0\".repeat(identifier(s.substring(result.length+1)).length+1);\r\n\t\t\telse throw new Error(\"Invalid object destructuring\");\r\n\t\t}\r\n\t}\r\n\tif(s[0]=='\"'||s[0]==\"'\"||s[0]=='`'){\r\n\t\tfor(let i=1; i<s.length; i++)\r\n\t\t\tif(s[i]==s[0]) return s.substring(0,i+1);\r\n\t\t\telse if(s[i]=='\\\\')\r\n\t\t\t\tswitch(s[i+1]){\r\n\t\t\t\t\tcase 'u':\r\n\t\t\t\t\t\ti+=5;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'x':\r\n\t\t\t\t\t\ti+=3;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\ti+=1;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\tthrow new Error(\"Missing end of string\");\r\n\t}\r\n\r\n\tfor(let i=0; i<s.length; i++)\r\n\t\tif(s[i]==','||s[i]==']'||s[i]=='}'||s[i]==')'||s[i]=='=')\r\n\t\t\treturn s.substring(0,i);\r\n\treturn s;\r\n}","import {isConnected} from \"../connection/WebSocketConnection.js\";\r\nimport {randomId,RpcId} from \"../connection/RpcId.js\";\r\nimport {callRemoteFunction} from \"../types/functions/FunctionCallContext.js\";\r\nimport {RpcObjectGetMethods,RpcObjectGetMethodSignatures} from \"../types/RpcObject.js\";\r\nimport {RpcError} from \"../types/RpcError.js\";\r\nimport {RpcMetaMethodNotFoundError,RpcMethodNotFoundError} from \"../types/errors/PredefinedErrors.js\";\r\nimport {getFunctionParameterNames} from \"./functionParameterNames\";\r\n\r\n\r\nexport type Func=((...args:any[])=>Promise<any>)&{\r\n\t[RpcObjectGetMethodSignatures]?:(ts:boolean)=>Promise<[parameters:string[],returns:string][]>\r\n};\r\nexport type Invoker={\r\n\t[RpcObjectGetMethods]?:()=>Promise<string[]>,\r\n\t[RpcObjectGetMethodSignatures]?:(method:string,ts:boolean)=>Promise<[parameters:string[],returns:string][]>,\r\n\t[s:string]:Func | any,\r\n};\r\nexport const registeredFunctions:Invoker=Object.create(null);\r\nexport const registeredTypes=new Map<string,Invoker>();\r\nregisteredTypes.set(\"$\"+RpcId,registeredFunctions);\r\n\r\n\r\nexport function generateTypeName(){\r\n\treturn \"$\"+RpcId+\"$\"+randomId();\r\n}\r\n\r\nexport async function registerType(type:string,invoker:Invoker):Promise<void>{\r\n\tif(registeredTypes.has(type)) return;\r\n\tregisteredTypes.set(type,invoker);\r\n\t\r\n\ttry{\r\n\t\tif(isConnected)\r\n\t\t\tawait callRemoteFunction(null,'+',type);\r\n\t}catch(e){\r\n\t\tconsole.error(`[Rpc] Error registering type \"${type}\":`,e);\r\n\r\n\t\tregisteredTypes.delete(type);\r\n\t}\r\n}\r\n\r\nexport async function unregisterType(type:string):Promise<void>{\r\n\tif(!registeredTypes.has(type)) return;\r\n\r\n\ttry{\r\n\t\tif(isConnected)\r\n\t\t\tawait callRemoteFunction(null,'-',type);\r\n\t}catch(e){\r\n\t\tconsole.error(`[Rpc] Error unregistering type \"${type}\":`,e);\r\n\r\n\t\t//Also delete locally, as it won't be listened to, and on the server it probably is already unregistered\r\n\t}\r\n\tregisteredTypes.delete(type);\r\n}\r\n\r\n\r\n\r\nexport async function invoke(invoker:Invoker,type:string,method:string | null,...args:any[]):Promise<any>{\r\n\tif(method!=null){\r\n\t\tlet func=invoker[method];\r\n\t\tif(func==null){\r\n\t\t\tlet ignoreCase=(await getMethods(invoker)).find(s=>s.toLowerCase()==method.toLowerCase());\r\n\t\t\tif(ignoreCase!=null) func=invoker[ignoreCase];\r\n\t\t}\r\n\t\t//Try finding the same method on a default object, if it is reference equals, then it is a builtin function, that should not be available via RPC\r\n\t\tconst reference=({})[method];\r\n\r\n\t\tif(func==null||func===reference)throw RpcMethodNotFoundError.new(type,method);\r\n\t\ttry{\r\n\t\t\treturn await (({\r\n\t\t\t\tasync $RPC_MARKER_BEGIN$(){\r\n\t\t\t\t\treturn await func.call(invoker,...args);\r\n\t\t\t\t}\r\n\t\t\t})[\"$RPC_MARKER_BEGIN$\"])();\r\n\t\t\t//return await rpcMarkInternal(async()=>await func.call(invoker,...args));\r\n\t\t}catch(e){\r\n\t\t\tthrow RpcError.wrapAndFreeze(e as Error);\r\n\t\t}\r\n\t}\r\n\r\n\tconst meta=args.length==0?null:args[0];\r\n\tswitch(meta){\r\n\t\tcase \"M\":\r\n\t\t\treturn getMethods(invoker);\r\n\t\tcase \"S\":\r\n\t\t\treturn getMethodSignatures(invoker,type,args[1]==null?null:\"\"+args[1],!!args[2]);\r\n\t\tdefault:\r\n\t\t\tthrow RpcMetaMethodNotFoundError.new(type,meta);\r\n\t}\r\n}\r\nasync function getMethodSignatures(invoker:Invoker,type:string,method:string|null,ts:boolean):Promise<[parameters:string[],returns:string][]>{\r\n\tif(method==null)return [\r\n\t\t[[\"M\"],\"string[]\"],\r\n\t\t[[\"S\",ts?\"method:string|null\":\"string? method\",ts?\"ts:boolean\":\"bool ts\"],ts?\"[parameters:string[],returns:string][]\":\"(string[] parameters,string @return)[]\"],\r\n\t];\r\n\tconst getter=invoker[RpcObjectGetMethodSignatures];\r\n\tif(getter) return await getter.call(invoker,method,ts);\r\n\t\r\n\tconst func:Func=invoker[method];\r\n\tif(!func) throw new RpcMethodNotFoundError(type,method);\r\n\tif(func[RpcObjectGetMethodSignatures]) return func[RpcObjectGetMethodSignatures].call(func,ts);\r\n\r\n\treturn [\r\n\t\t[getFunctionParameterNames(func),ts?\"unknown\":\"dynamic\"]\r\n\t];\r\n}\r\n\r\nasync function getMethods(invoker:Invoker):Promise<string[]>{\r\n\tconst getter=invoker[RpcObjectGetMethods];\r\n\tif(getter) return await getter.call(invoker);\r\n\r\n\treturn Object.getOwnPropertyNames(invoker).filter(key=>typeof invoker[key]==\"function\");\r\n}","import {FunctionCallContext} from \"./FunctionCallContext.js\";\r\nimport {RpcError} from \"../RpcError.js\";\r\nimport {freeDynamic} from \"../data/DynamicData.js\";\r\nimport {Rpc} from \"../../rpc\";\r\n\r\ntype Action<T>=(t:T)=>void;\r\n\r\n// noinspection JSUnusedGlobalSymbols\r\nexport class PendingCall<T=unknown> implements Promise<T>{\r\n\tpublic readonly [Symbol.toStringTag]:string=\"PendingCall\";\r\n\tpublic finished=false;\r\n\tpublic readonly promise:Promise<T>;\r\n\r\n\tconstructor(skip:number,dispose:unknown[]){\r\n\t\ttry{\r\n\t\t\t// noinspection ExceptionCaughtLocallyJS\r\n\t\t\tthrow new Error();\r\n\t\t}catch(stackSource){\r\n\t\t\tthis.promise=new Promise((resolve,reject)=>{\r\n\t\t\t\tresolveCall.set(this,t=>{\r\n\t\t\t\t\tresolveCall.delete(this);\r\n\t\t\t\t\trejectCall.delete(this);\r\n\t\t\t\t\tthis.finished=true;\r\n\t\t\t\t\tresolve(t);\r\n\t\t\t\t\tfreeDynamic(dispose);\r\n\t\t\t\t});\r\n\t\t\t\trejectCall.set(this,e=>{\r\n\t\t\t\t\tresolveCall.delete(this);\r\n\t\t\t\t\trejectCall.delete(this);\r\n\t\t\t\t\tthis.finished=true;\r\n\t\t\t\t\treject(e instanceof RpcError?e.unfreeze(stackSource as any,skip):e);\r\n\t\t\t\t\tfreeDynamic(dispose);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tcatch<TResult=never>(onrejected?:((reason:any)=>(PromiseLike<TResult> | TResult)) | undefined | null):Promise<T | TResult>{\r\n\t\treturn this.promise.catch(onrejected);\r\n\t}\r\n\r\n\tfinally(onfinally?:(()=>void) | undefined | null):Promise<T>{\r\n\t\treturn this.promise.finally(onfinally);\r\n\t}\r\n\r\n\tthen<TResult1=T,TResult2=never>(onfulfilled?:((value:T)=>(PromiseLike<TResult1> | TResult1)) | undefined | null,onrejected?:((reason:any)=>(PromiseLike<TResult2> | TResult2)) | undefined | null):Promise<TResult1 | TResult2>{\r\n\t\treturn this.promise.then(onfulfilled,onrejected);\r\n\t}\r\n\r\n\tsendMessage(..._args:any[]):PendingCall<T>{//overridden by callFunction and callLocal\r\n\t\treturn this;\r\n\t}\r\n\r\n\taddMessageListener<Args extends any[]=any[]>(func:(...args:Args)=>void):PendingCall<T>{\r\n\t\treturn registerReceive(this,func as (...args:any[])=>void);\r\n\t}\r\n\r\n\tcancel(){}//overridden by callFunction and callLocal\r\n\t\r\n\tgetCaller():Promise<string>{\r\n\t\treturn Promise.resolve(Rpc.prettyName);\r\n\t}//overridden by callFunction and callLocal\r\n\r\n\t[Symbol.asyncIterator]():AsyncIterator<any[]>{\r\n\t\treturn getAsyncIterator(this);\r\n\t}\r\n}\r\n\r\nexport function getAsyncIterator(call:PendingCall | FunctionCallContext):AsyncIterator<unknown[]>{\r\n\tlet didReceive:IteratorResult<unknown[]>[]=[];\r\n\tlet waitReceive:((r:IteratorResult<unknown[]>)=>void)[]=[];\r\n\r\n\tcall.promise.catch(()=>{});\r\n\tcall.promise.finally(()=>{\r\n\t\tfor(let request of waitReceive) request({done:true,value:undefined});\r\n\t});\r\n\tcall.addMessageListener((...args)=>{\r\n\t\t(waitReceive.shift()??didReceive.push)({done:false,value:args});\r\n\t});\r\n\r\n\treturn {\r\n\t\tasync next():Promise<IteratorResult<unknown[]>>{\r\n\t\t\tif(call.finished) return {done:true,value:undefined};\r\n\t\t\treturn didReceive.shift()?? await new Promise(res=>waitReceive.push(res));\r\n\t\t},\r\n\t};\r\n}\r\n\r\nexport const resolveCall=new WeakMap<PendingCall,Action<any>>();\r\nexport const rejectCall=new WeakMap<PendingCall,Action<unknown>>();\r\nexport const pendingMap=new WeakMap<PendingCall | FunctionCallContext,(any[])[]>();\r\nexport const listenersMap=new WeakMap<PendingCall | FunctionCallContext,((...args:any[])=>void)[]>();\r\n\r\nexport function registerReceive<AnyCall extends PendingCall | FunctionCallContext>(call:AnyCall,func:(...args:any[])=>void){\r\n\tif(listenersMap.has(call)){\r\n\t\tlistenersMap.get(call)!.push(func);\r\n\t}else{\r\n\t\tlistenersMap.set(call,[func]);\r\n\t\tconst pendings=pendingMap.get(call)??[];\r\n\t\tfor(let pending of pendings){\r\n\t\t\ttry{\r\n\t\t\t\tfunc(...pending);\r\n\t\t\t}catch(e){\r\n\t\t\t\tconsole.warn(\"[Rpc] Error while handling pending message:\",e);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn call;\r\n}\r\n\r\nexport function runReceiveMessage(call:PendingCall | FunctionCallContext,args:any[]){\r\n\tif(call.finished) return;\r\n\r\n\tif(listenersMap.has(call)){\r\n\t\tfor(let func of listenersMap.get(call)!){\r\n\t\t\ttry{\r\n\t\t\t\tfunc(...args);\r\n\t\t\t}catch(e){\r\n\t\t\t\tconsole.warn(\"[Rpc] Error while receiving message:\",e);\r\n\t\t\t}\r\n\t\t}\r\n\t}else if(pendingMap.has(call)){\r\n\t\tpendingMap.set(call,[...pendingMap.get(call)!,args]);\r\n\t}else{\r\n\t\tpendingMap.set(call,[args]);\r\n\t}\r\n}","import {invoke,registeredTypes} from \"../../internal/RegisteredTypes.js\";\r\nimport {getAsyncIterator,PendingCall,registerReceive,rejectCall,resolveCall,runReceiveMessage} from \"./PendingCall.js\";\r\nimport {DataOutput} from \"../data/DataOutput.js\";\r\nimport {PacketType,sendCall,sendRaw} from \"../../connection/Connection.js\";\r\nimport {_webSocket,isConnected} from \"../../connection/WebSocketConnection.js\";\r\nimport {RpcError} from \"../RpcError.js\";\r\nimport {RpcConnectionError} from \"../errors/PredefinedErrors.js\";\r\n\r\n\r\nlet currentContext:FunctionCallContext | null=null;\r\n\r\nexport function runWithContext<T>(func:()=>T,context:FunctionCallContext):T{\r\n\tconst previous:FunctionCallContext | null=currentContext;\r\n\tcurrentContext=context;\r\n\ttry{\r\n\t\treturn func();\r\n\t}finally{\r\n\t\tcurrentContext=previous;\r\n\t}\r\n}\r\n\r\nexport function getFunctionContext():FunctionCallContext{\r\n\tif(currentContext==null) throw new Error(\"FunctionCallContext not available\");\r\n\treturn currentContext;\r\n}\r\n\r\n\r\nlet nextId=0;\r\n\r\nexport function callRemoteFunction<T=unknown>(type:string | null,method:string | null,...args:any[]):PendingCall<T>{\r\n\tif(type!=null){\r\n\t\tconst local=registeredTypes.get(type);\r\n\t\tif(local) return callLocalFunction<T>(invoke.bind(null,local,type,method,...args),type,method,args,3);\r\n\t}\r\n\r\n\tconst already:unknown[]=[];\r\n\tconst call=new PendingCall<T>(2,already);\r\n\r\n\tconst buff=new DataOutput();\r\n\tconst callId=nextId++;\r\n\ttry{\r\n\t\tbuff.writeByte(PacketType.FunctionCall);\r\n\t\tbuff.writeLength(callId);\r\n\t\tbuff.writeString(type);\r\n\t\tbuff.writeString(method);\r\n\t\tbuff.writeArray(args,d=>buff.writeDynamic(d,already));\r\n\t}catch(e){\r\n\t\trejectCall.get(call)?.(e);\r\n\t\treturn call;\r\n\t}\r\n\r\n\tif(!(isConnected||(type==null&&_webSocket!=null))){\r\n\t\trejectCall.get(call)?.(RpcConnectionError.new(\"Not connected\"));\r\n\t\treturn call;\r\n\t}\r\n\tcall.sendMessage=(...msgArgs)=>{\r\n\t\tif(call.finished) return call;\r\n\t\tconst msg=new DataOutput();\r\n\t\tmsg.writeByte(PacketType.MessageToExecutor);\r\n\t\tmsg.writeLength(callId);\r\n\t\tconst list:unknown[]=[];\r\n\t\tmsg.writeArray(msgArgs,d=>msg.writeDynamic(d,list));\r\n\t\talready.push(...list);\r\n\r\n\t\tsendRaw(msg);\r\n\t\treturn call;\r\n\t};\r\n\tcall.cancel=()=>{\r\n\t\tif(call.finished) return;\r\n\t\tconst msg=new DataOutput();\r\n\t\tmsg.writeByte(PacketType.FunctionCancel);\r\n\t\tmsg.writeLength(callId);\r\n\r\n\t\tsendRaw(msg);\r\n\t};\r\n\tcall.getCaller=()=>callRemoteFunction(null,\"c\",callId);\r\n\r\n\tsendCall(callId,call,buff);\r\n\r\n\treturn call;\r\n}\r\n\r\n\r\nexport function callLocal<T>(func:()=>(Promise<T> | T)):PendingCall<T>{\r\n\treturn callLocalFunction(func,null,null,null,3);\r\n}\r\n\r\nfunction callLocalFunction<T>(func:()=>(Promise<T> | T),type:string | null,method:string | null,args:any[] | null,skip:number){\r\n\tconst pending=new PendingCall<T>(skip,[]);\r\n\r\n\tconst controller=new AbortController();\r\n\tconst context:FunctionCallContext={\r\n\t\ttype,\r\n\t\tmethod,\r\n\t\tsendMessage:(...sending)=>{\r\n\t\t\tpending.finished||runReceiveMessage(pending,sending);\r\n\t\t\treturn context;\r\n\t\t},\r\n\t\tget finished(){\r\n\t\t\treturn pending.finished\r\n\t\t},\r\n\t\tpromise:pending,\r\n\t\taddMessageListener:(func:(...args:any[])=>void)=>registerReceive(context,func),\r\n\t\tcancelToken:controller.signal,\r\n\t\tcancelSelf:()=>controller.abort(),\r\n\t\t[Symbol.asyncIterator]:()=>getAsyncIterator(context),\r\n\t};\r\n\tpending.sendMessage=(...received)=>{\r\n\t\tpending.finished||runReceiveMessage(context,received);\r\n\t\treturn pending;\r\n\t};\r\n\tpending.cancel=()=>pending.finished||context.cancelSelf();\r\n\r\n\t// noinspection JSIgnoredPromiseFromCall\r\n\tinvokeForPromise(func,context,resolveCall.get(pending),rejectCall.get(pending),type,method,args);\r\n\r\n\treturn pending;\r\n}\r\n\r\nexport async function invokeForPromise<T>(func:()=>T,context:FunctionCallContext,resolve:((t:T)=>void) | undefined,reject:((e:RpcError)=>void) | undefined,\r\n\t\t\t\t\t\t\t\t\t\t  type:string | null,method:string | null,args:any[] | null){\r\n\ttry{\r\n\t\tlet result:Promise<T>;\r\n\t\tconst previous:FunctionCallContext | null=currentContext;\r\n\t\tcurrentContext=context;\r\n\t\ttry{\r\n\t\t\tresult=await (({\r\n\t\t\t\tasync $RPC_MARKER_BEGIN$(){\r\n\t\t\t\t\treturn await func() as any;\r\n\t\t\t\t}\r\n\t\t\t})[\"$RPC_MARKER_BEGIN$\"])();\r\n\t\t}finally{\r\n\t\t\tcurrentContext=previous;\r\n\t\t}\r\n\t\tresolve?.(await result);\r\n\t}catch(e){\r\n\t\treject?.(RpcError\r\n\t\t\t.wrapAndFreeze(e as Error)\r\n\t\t\t.append(type,method,args));\r\n\t}\r\n}\r\n\r\nexport interface FunctionCallContext{\r\n\treadonly type:string | null\r\n\treadonly method:string | null\r\n\treadonly finished:boolean\r\n\treadonly promise:Promise<unknown>\r\n\r\n\tsendMessage(...args:any[]):FunctionCallContext\r\n\r\n\taddMessageListener(func:(...args:any[])=>void):FunctionCallContext\r\n\r\n\tcancelToken:AbortSignal\r\n\r\n\tcancelSelf():void\r\n\r\n\t[Symbol.asyncIterator]():AsyncIterator<any[]>;\r\n}","import {RpcId} from \"../connection/RpcId.js\";\r\nimport {callRemoteFunction} from \"./functions/FunctionCallContext.js\";\r\nimport {PendingCall} from \"./functions/PendingCall.js\";\r\nimport {registeredFunctions} from \"../internal/RegisteredTypes.js\";\r\n\r\n\r\ntype ParamsOrEmpty<T>=T extends (...args: infer Params)=>any?Params: unknown extends T?any[]: [];\r\ntype ReturnTypeFromAnything<T>=T extends (...args: any)=>infer ReturnType?ReturnType: T;\r\ntype UnwrapPromise<T>=T extends Promise<infer PromiseType>?PromiseType: T;\r\n\r\nexport type RpcFunction<FuncOrReturnType>=InstanceType<typeof RpcFunction<FuncOrReturnType>>;\r\n\r\nexport const RpcFunction=class RpcFunction<FuncOrReturnType>\r\n\textends (function Extendable(func: Function){return Object.setPrototypeOf(func,new.target.prototype);} as any as {\r\n\t\tnew<FuncOrReturnType=unknown>(func: Function): {\r\n\t\t\t//Complex call signature from generic, to allow easier definition later on\r\n\t\t\t(...args: ParamsOrEmpty<FuncOrReturnType>): PendingCall<UnwrapPromise<ReturnTypeFromAnything<FuncOrReturnType>>>;\r\n\t\t}\r\n\t})<FuncOrReturnType>{\r\n\r\n\tconstructor(\r\n\t\tpublic readonly type: string,\r\n\t\tpublic readonly method: string,\r\n\t){super(callRemoteFunction.bind(null,type,method));}\r\n\r\n\tasync getMethodSignatures(typeScript:boolean=false):Promise<[parameters:string[],returns:string][]>{\r\n\t\treturn callRemoteFunction(this.type,null,\"S\",this.method,typeScript);\r\n\t}\r\n\r\n\ttoString(){\r\n\t\treturn `rpc (...params) => ${this.type??\"null\"}.${this.method}(...params)`;\r\n\t}\r\n};\r\n\r\nlet nextId: number=Date.now();\r\nconst functionCache=new WeakMap<((...args: any)=>any),string>();\r\n\r\nexport function registerFunction<T extends ((...args: any)=>any)>(func: T): RpcFunction<T>{\r\n\tif(func instanceof RpcFunction) return func;\r\n\tconst already=functionCache.get(func);\r\n\tif(already!=null)return new RpcFunction(\"$\"+RpcId,already);\r\n\tconst id=(nextId++).toString(16);\r\n\r\n\tregisteredFunctions[id]=func;\r\n\tfunctionCache.set(func,id);\r\n\r\n\tconst type=\"$\"+RpcId;\r\n\treturn new RpcFunction(type,id);\r\n}\r\n\r\nexport function unregisterFunction(func: RpcFunction<any>){\r\n\tconst type=\"$\"+RpcId;\r\n\tif(func.type!=type) throw new Error(\"Can't unregister RemoteFunction, that was not registered locally\");\r\n\r\n\tdelete registeredFunctions[func.method];\r\n\tfunctionCache.delete(func);\r\n}","import {RpcFunction} from \"./RpcFunction.js\";\r\nimport {callRemoteFunction} from \"./functions/FunctionCallContext.js\";\r\n\r\nexport const RpcObjectType=Symbol(\"RpcObjectType\");\r\nexport const RpcObjectExists=Symbol(\"RpcObjectExists\");\r\nexport const RpcObjectGetMethods=Symbol(\"RpcObjectGetMethods\");\r\nexport const RpcObjectGetMethodSignatures=Symbol(\"RpcObjectGetMethodSignatures\");\r\nexport type RpcObject<T=RpcObjectTemplate,Type=string>={\r\n\t[x in keyof T]:\r\n\tx extends \"then\" | symbol?\r\n\t\tT[x]:\r\n\t\tT[x] extends (...args: any[])=>unknown?\r\n\t\t\tRpcFunction<T[x]>:\r\n\t\t\tRpcFunction<any>;\r\n} & {\r\n\t[RpcObjectType]: Type,\r\n\t[RpcObjectExists]: ()=>Promise<boolean>\r\n\t[RpcObjectGetMethods]: ()=>Promise<string[]>\r\n};\r\n\r\nexport type RpcObjectTemplate={\r\n\t[s: string]: (...args: any[])=>unknown\r\n}\r\n\r\n\r\nexport function createRemoteObject<\r\n\tT extends object=RpcObjectTemplate,\r\n\tTypeString extends string=string\r\n>(\r\n\ttype: TypeString,\r\n\ttarget: T=new class RpcObject{[RpcObjectType]=type} as T,\r\n): RpcObject<T,TypeString>{\r\n\t\r\n\tconst cache=new Map<string,RpcFunction<any>>();\r\n\t\r\n\t\r\n\treturn new Proxy<RpcObject<T,TypeString>>(<any>target,{\r\n\t\tget(_: never,p: string | symbol): any{\r\n\t\t\tif(p==RpcObjectType) return type;\r\n\t\t\tif(p==RpcObjectExists) return ()=>callRemoteFunction(null,\"E\",type);\r\n\t\t\tif(p==RpcObjectGetMethods) return ()=>callRemoteFunction(type,null,\"M\");\r\n\t\t\tif(typeof p!=\"string\"||\r\n\t\t\t\tp==\"then\"//otherwise every RemoteObject would be thenable => would interfere with async await\r\n\t\t\t) return (<any>target)[p];\r\n\t\t\tif(cache.has(p)) return cache.get(p);\r\n\r\n\t\t\tconst func=new RpcFunction(\r\n\t\t\t\ttype,\r\n\t\t\t\tp);\r\n\t\t\tcache.set(p,func);\r\n\t\t\treturn func;\r\n\t\t},\r\n\t\tconstruct(target: any,argArray: any[]): object{\r\n\t\t\treturn new target(...argArray);\r\n\t\t},\r\n\t\thas(_:never,p: string | symbol): boolean{\r\n\t\t\treturn p==RpcObjectType||p==RpcObjectGetMethods||p==RpcObjectExists||p in target;\r\n\t\t},\r\n\t});\r\n}\r\n\r\n\r\nexport const RPC_ROOT=new Proxy({},{\r\n\tget:(_,prop)=>typeof prop==\"string\"?createRemoteObject(prop):undefined,\r\n\thas:(_,prop)=>typeof prop==\"string\"&&prop!=\"then\",\r\n}) as Record<string,RpcObject>;","import {DataInput} from \"./DataInput.js\";\r\nimport {createRemoteObject,RpcObjectType} from \"../RpcObject.js\";\r\nimport {DataOutput} from \"./DataOutput.js\";\r\nimport {registerFunction,RpcFunction,unregisterFunction} from \"../RpcFunction.js\";\r\n\r\nexport const writeRegistry: [id: string,check: (d: unknown)=>boolean,write: (data: DataOutput,o: unknown,already: unknown[])=>void][]=[];\r\nexport const readRegistry=new Map<string,(data: DataInput,already: unknown[])=>unknown>();\r\n\r\nexport function readDynamic(data: DataInput,already: unknown[]){\r\n\tlet objectId=data.readLength();\r\n\r\n\tif(objectId<0){\r\n\t\tobjectId= -objectId;\r\n\t\tswitch(objectId%4){\r\n\t\t\tcase 0:\r\n\t\t\t\treturn already[objectId/4];\r\n\t\t\tcase 1:\r\n\t\t\t\treturn new TextDecoder().decode(data.readBuffer((objectId-1)/4));\r\n\t\t\tcase 2:{\r\n\t\t\t\tconst o: Record<string,any>={};\r\n\t\t\t\talready.push(o);\r\n\t\t\t\tfor(let i=0; i<(objectId-2)/4; i++){\r\n\t\t\t\t\tconst key=data.readString();\r\n\t\t\t\t\to[key!]=readDynamic(data,already);\r\n\t\t\t\t}\r\n\t\t\t\treturn o;\r\n\t\t\t}\r\n\t\t\tcase 3:{\r\n\t\t\t\tconst o=new Array((objectId-3)/4);\r\n\t\t\t\talready.push(o);\r\n\t\t\t\tfor(let i=0; i<o.length; i++) o[i]=readDynamic(data,already);\r\n\t\t\t\treturn o;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthrow new Error(\"Unreachable code reached\");\r\n\t}else if(objectId>=128){\r\n\t\tconst type=new TextDecoder().decode(data.readBuffer(objectId-128));\r\n\t\tconst registryEntry=readRegistry.get(type);\r\n\t\tif(registryEntry)\r\n\t\t\treturn registryEntry(data,already);\r\n\t\tthrow new Error(\"Unknown data type: \"+type);\r\n\t}else{\r\n\t\tswitch(String.fromCodePoint(objectId)){\r\n\t\t\tcase 'n':\r\n\t\t\t\treturn null;\r\n\t\t\tcase 't':\r\n\t\t\t\treturn true;\r\n\t\t\tcase 'f':\r\n\t\t\t\treturn false;\r\n\t\t\tcase 'i':\r\n\t\t\t\treturn data.readInt();\r\n\t\t\tcase 'd':\r\n\t\t\t\treturn data.readDouble();\r\n\t\t\tcase 'l':\r\n\t\t\t\treturn data.readLong();\r\n\t\t\tcase 'b':\r\n\t\t\t\treturn data.readBuffer(data.readLength());\r\n\t\t\tcase 'D':\r\n\t\t\t\treturn new Date(Number(data.readLong()));\r\n\t\t\tcase 'R':{\r\n\t\t\t\tconst pattern=data.readString();\r\n\t\t\t\tconst flags=data.readByte();\r\n\r\n\t\t\t\treturn new RegExp(pattern!,\"g\"+\r\n\t\t\t\t\t((flags&1)?\"i\": \"\")+\r\n\t\t\t\t\t((flags&2)?\"m\": \"\"),\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tcase 'E':\r\n\t\t\t\treturn data.readError();\r\n\t\t\tcase 'O':\r\n\t\t\t\tconst objectType=data.readString();\r\n\t\t\t\tif(objectType==null) throw new Error(\"Type can't be null\");\r\n\t\t\t\treturn createRemoteObject(objectType);\r\n\t\t\tcase 'F':\r\n\t\t\t\tconst type=data.readString();\r\n\t\t\t\tif(type==null) throw new Error(\"Type can't be null\");\r\n\t\t\t\tconst method=data.readString();\r\n\t\t\t\tif(method==null) throw new Error(\"Method can't be null\");\r\n\t\t\t\tconst func=new RpcFunction(type,method);\r\n\t\t\t\talready.push(func);\r\n\t\t\t\treturn func;\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error(\"Unknown data type number: \"+objectId);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function writeDynamic(output: DataOutput,d: unknown,already: unknown[]){\r\n\tif(d==null) output.writeLength('n'.charCodeAt(0));\r\n\telse if(d===true) output.writeLength('t'.charCodeAt(0));\r\n\telse if(d===false) output.writeLength('f'.charCodeAt(0));\r\n\telse if(typeof d==\"number\"&&(d|0)===d){\r\n\t\toutput.writeLength('i'.charCodeAt(0));\r\n\t\toutput.writeInt(d);\r\n\t}else if(typeof d==\"number\"){\r\n\t\toutput.writeLength('d'.charCodeAt(0));\r\n\t\toutput.writeDouble(d);\r\n\t}else if(typeof d==\"bigint\"){\r\n\t\toutput.writeLength('l'.charCodeAt(0));\r\n\t\toutput.writeLong(d);\r\n\t}else if(d instanceof Uint8Array){\r\n\t\toutput.writeLength('b'.charCodeAt(0));\r\n\t\toutput.writeLength(d.length);\r\n\t\toutput.writeBuffer(d);\r\n\t}else if(d instanceof Date){\r\n\t\toutput.writeLength('D'.charCodeAt(0));\r\n\t\toutput.writeLong(+d);\r\n\t}else if(d instanceof RegExp){\r\n\t\toutput.writeLength('R'.charCodeAt(0));\r\n\t\toutput.writeString(d.source);\r\n\t\tconst flags=d.flags;\r\n\t\toutput.writeByte(\r\n\t\t\t(flags.includes(\"i\")?1: 0)||\r\n\t\t\t(flags.includes(\"m\")?2: 0),\r\n\t\t);\r\n\t}else if(d instanceof Error){\r\n\t\toutput.writeLength('E'.charCodeAt(0));\r\n\t\toutput.writeError(d);\r\n\t}else if(typeof d===\"object\"&&RpcObjectType in d){//RpcObject\r\n\t\toutput.writeLength('O'.charCodeAt(0));\r\n\t\toutput.writeString((d as any)[RpcObjectType]);\r\n\t}else if(typeof d===\"function\"){//RpcFunction\r\n\t\talready.push(d);\r\n\t\toutput.writeLength('F'.charCodeAt(0));\r\n\t\t\r\n\t\tlet rpcFunc:RpcFunction<any>;\r\n\t\tif(d instanceof RpcFunction)rpcFunc=d;\r\n\t\telse{\r\n\t\t\trpcFunc=registerFunction(d as any);\r\n\t\t\tonFree.set(d,()=>unregisterFunction(rpcFunc));\r\n\t\t}\r\n\r\n\t\toutput.writeString(rpcFunc.type);\r\n\t\toutput.writeString(rpcFunc.method);\r\n\t\t\r\n\t}else if(already.includes(d)){\r\n\t\toutput.writeLength(-(already.indexOf(d)*4/* +0 */));\r\n\t}else if(typeof d===\"string\"){\r\n\t\tconst buffer=new TextEncoder().encode(d);\r\n\t\toutput.writeLength(-(buffer.length*4+1));\r\n\t\toutput.writeBytes(buffer);\r\n\t} else if(Array.isArray(d)){\r\n\t\talready.push(d);\r\n\t\toutput.writeLength(-(d.length*4+3));\r\n\t\tfor(let element of d) writeDynamic(output,element,already);\r\n\t}else{\r\n\t\tfor(let [id,check,write] of writeRegistry){\r\n\t\t\tif(!check(d)) continue;\r\n\t\t\tconst idBytes=new TextEncoder().encode(id);\r\n\t\t\toutput.writeLength(idBytes.length+128);\r\n\t\t\toutput.writeBytes(idBytes);\r\n\t\t\twrite(output,d,already);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif(typeof d===\"object\"){\r\n\t\t\talready.push(d);\r\n\t\t\tconst entries=Object.entries(d);\r\n\t\t\toutput.writeLength(-(entries.length*4+2));\r\n\t\t\tfor(let [key,value] of entries){\r\n\t\t\t\toutput.writeString(key);\r\n\t\t\t\twriteDynamic(output,value,already);\r\n\t\t\t}\r\n\t\t}else throw new Error(\"Unknown type for \"+d);\r\n\t}\r\n}\r\n\r\nconst onFree=new WeakMap<any,VoidFunction>();\r\nexport function freeDynamic(already:unknown[]){\r\n\tfor(let element of already)\r\n\t\tonFree.get(element)?.();\r\n}","import {RpcError} from \"../RpcError.js\";\r\nimport {writeDynamic} from \"./DynamicData.js\";\r\n\r\n// noinspection JSUnusedGlobalSymbols\r\nexport class DataOutput{\r\n\tprivate _buf:Uint8Array;\r\n\tprivate _data:DataView;\r\n\tprivate _count:number=0;\r\n\r\n\tconstructor(size:number | Uint8Array=32){\r\n\t\tthis._buf=typeof size===\"number\"?new Uint8Array(size):size;\r\n\t\tthis._data=new DataView(this._buf.buffer);\r\n\t}\r\n\r\n\tprivate ensureCapacity(additional:number){\r\n\t\tadditional+=this._count;\r\n\t\tif(additional>this._buf.byteLength){\r\n\t\t\tlet replacement=new Uint8Array(Math.max(this._buf.byteLength*2,additional));\r\n\t\t\tthis._data=new DataView(replacement.buffer);\r\n\r\n\t\t\treplacement.set(this._buf);\r\n\t\t\tthis._buf=replacement;\r\n\t\t}\r\n\t}\r\n\r\n\twriteByte(b:number):void{\r\n\t\tthis.ensureCapacity(1);\r\n\t\tthis._buf[this._count]=b;\r\n\t\tthis._count++;\r\n\t}\r\n\r\n\twriteBytes(b:ArrayLike<number>):void{\r\n\t\tthis.ensureCapacity(b.length);\r\n\t\tthis._buf.set(b,this._count);\r\n\t\tthis._count+=b.length;\r\n\t}\r\n\r\n\twriteBuffer(buf:Uint8Array):void{\r\n\t\tthis.writeBytes(buf);\r\n\t}\r\n\r\n\twriteBoolean(b:boolean):void{\r\n\t\tthis.writeByte(b?1:0);\r\n\t}\r\n\r\n\twriteNullBoolean(b:boolean | null):void{\r\n\t\tthis.writeByte(b==null?2:b?1:0);\r\n\t}\r\n\r\n\twriteShort(n:number):void{\r\n\t\tthis.ensureCapacity(2);\r\n\t\tthis._data.setInt16(this._count,n);\r\n\t\tthis._count+=2;\r\n\t}\r\n\r\n\twriteChar(c:string):void{\r\n\t\tthis.writeShort(c.charCodeAt(0));\r\n\t}\r\n\r\n\twriteInt(n:number):void{\r\n\t\tthis.ensureCapacity(4);\r\n\t\tthis._data.setInt32(this._count,n);\r\n\t\tthis._count+=4;\r\n\t}\r\n\r\n\twriteLong(n:bigint | number):void{\r\n\t\tif(typeof n===\"number\"){\r\n\t\t\tthis.writeInt(n/(2**32));\r\n\t\t\tthis.writeInt(n%(2**32));\r\n\t\t}else{\r\n\t\t\tthis.writeInt(Number(n/BigInt(2**32)));\r\n\t\t\tthis.writeInt(Number(n%BigInt(2**32)));\r\n\t\t}\r\n\t}\r\n\r\n\twriteFloat(n:number):void{\r\n\t\tthis.ensureCapacity(4);\r\n\t\tthis._data.setFloat32(this._count,n);\r\n\t\tthis._count+=4;\r\n\t}\r\n\r\n\twriteDouble(n:number):void{\r\n\t\tthis.ensureCapacity(8);\r\n\t\tthis._data.setFloat64(this._count,n);\r\n\t\tthis._count+=8;\r\n\t}\r\n\r\n\twriteString(s:string | null){\r\n\t\tif(s==null){\r\n\t\t\tthis.writeLength(-1);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tlet array=new TextEncoder().encode(s);\r\n\t\tthis.writeLength(array.length);\r\n\t\tthis.writeBytes(array);\r\n\t}\r\n\r\n\twriteLength(i:number){\r\n\t\tlet u=(i<0?~i:i)>>>0;// \">>>0\" : convert to unsigned\r\n\t\twhile(u>=0x80){\r\n\t\t\tthis.writeByte(u|0x80);\r\n\t\t\tu>>=7;\r\n\t\t}\r\n\t\tif(i<0){\r\n\t\t\tthis.writeByte(u|0x80);\r\n\t\t\tthis.writeByte(0);\r\n\t\t}else{\r\n\t\t\tthis.writeByte(u);\r\n\t\t}\r\n\t}\r\n\r\n\twriteByteArray(arr:ArrayLike<number> | null){\r\n\t\tif(!arr) this.writeLength(-1);\r\n\t\telse{\r\n\t\t\tthis.writeLength(arr.length);\r\n\t\t\tthis.writeBytes(arr);\r\n\t\t}\r\n\t}\r\n\r\n\twriteArray<T>(arr:ArrayLike<T> | null,writeFunction:(t:T)=>void){\r\n\t\tif(!arr) this.writeLength(-1);\r\n\t\telse{\r\n\t\t\tthis.writeLength(arr.length);\r\n\t\t\tfor(let i=0; i<arr.length; i++)\r\n\t\t\t\twriteFunction.call(this,arr[i]!);\r\n\t\t}\r\n\t}\r\n\r\n\ttoBuffer(from=0):Uint8Array{\r\n\t\treturn this._buf.slice(from,this._count-from);\r\n\t}\r\n\r\n\twriteError(error:Error){\r\n\t\ttry{// noinspection ExceptionCaughtLocallyJS\r\n\t\t\tthrow RpcError.wrapAndFreeze(error)\r\n\t\t}catch(e){\r\n\t\t\t(e as RpcError).write(this);\r\n\t\t}\r\n\t}\r\n\r\n\twriteDynamic(value:any,already:unknown[]=[]){\r\n\t\twriteDynamic(this,value,already);\r\n\t}\r\n}\r\n","// noinspection ExceptionCaughtLocallyJS\r\n\r\nimport {_webSocket} from \"./WebSocketConnection.js\";\r\nimport {DataOutput} from \"../types/data/DataOutput.js\";\r\nimport {DataInput} from \"../types/data/DataInput.js\";\r\nimport {\r\n\tgetAsyncIterator,\r\n\tPendingCall,\r\n\tregisterReceive,\r\n\trejectCall,\r\n\tresolveCall,\r\n\trunReceiveMessage,\r\n} from \"../types/functions/PendingCall.js\";\r\nimport {invoke,registeredTypes} from \"../internal/RegisteredTypes.js\";\r\nimport {FunctionCallContext,invokeForPromise} from \"../types/functions/FunctionCallContext.js\";\r\nimport {freeDynamic} from \"../types/data/DynamicData.js\";\r\nimport {RpcConnectionError,RpcDataError,RpcError,RpcTypeNotFoundError} from \"../rpc.js\";\r\n\r\n\r\nconst activeRequests=new Map<number,PendingCall>();\r\nconst currentlyExecuting=new Map<number,FunctionCallContext>();\r\n\r\nexport function disposeConnection(e:Error){\r\n\tfor(let pending of activeRequests.values()) rejectCall.get(pending)?.(e);\r\n\tactiveRequests.clear();\r\n\r\n\tfor(let ctx of currentlyExecuting.values()) ctx.cancelSelf();\r\n}\r\n\r\nexport function sendRaw(buff:DataOutput){\r\n\tif(_webSocket==null) throw RpcConnectionError.new(\"Not connected\");\r\n\t_webSocket.send(buff.toBuffer());\r\n}\r\n\r\nexport function sendCall(callId:number,call:PendingCall,buff:DataOutput){\r\n\tactiveRequests.set(callId,call);\r\n\ttry{\r\n\t\tsendRaw(buff);\r\n\t}catch(e){\r\n\t\trejectCall.get(call)?.(e);\r\n\t}\r\n}\r\n\r\nexport enum PacketType{\r\n\tFunctionCall=0,\r\n\tFunctionSuccess=1,\r\n\tFunctionError=2,\r\n\tFunctionCancel=3,\r\n\tMessageToExecutor=4,\r\n\tMessageToCaller=5,\r\n}\r\n\r\nexport async function receiveRpc(data:DataInput){\r\n\tconst packetType=data.readByte() as PacketType;\r\n\r\n\tswitch(packetType){\r\n\t\tcase PacketType.FunctionCall:{\r\n\t\t\tconst callId=data.readLength();\r\n\r\n\r\n\t\t\tconst already:unknown[]=[];\r\n\r\n\t\t\tlet finished:boolean=false;\r\n\t\t\tlet resolve:(t:unknown)=>void=null!;\r\n\t\t\tlet reject:(e:Error)=>void=null!;\r\n\r\n\t\t\tconst promise=new Promise((res,rej)=>{\r\n\t\t\t\tresolve=t=>{\r\n\t\t\t\t\tres(t);\r\n\t\t\t\t\tfinished=true;\r\n\r\n\t\t\t\t\tconst buff=new DataOutput();\r\n\t\t\t\t\tbuff.writeByte(PacketType.FunctionSuccess);\r\n\t\t\t\t\tbuff.writeLength(callId);\r\n\t\t\t\t\tbuff.writeDynamic(t);\r\n\t\t\t\t\tsendRaw(buff);\r\n\t\t\t\t\tcurrentlyExecuting.delete(callId);\r\n\r\n\t\t\t\t\tfreeDynamic(already);\r\n\t\t\t\t};\r\n\t\t\t\treject=e=>{\r\n\t\t\t\t\trej(e);\r\n\t\t\t\t\tfinished=true;\r\n\r\n\t\t\t\t\tconst buff=new DataOutput();\r\n\t\t\t\t\tbuff.writeByte(PacketType.FunctionError);\r\n\t\t\t\t\tbuff.writeLength(callId);\r\n\t\t\t\t\tbuff.writeError(e);\r\n\t\t\t\t\tsendRaw(buff);\r\n\t\t\t\t\tcurrentlyExecuting.delete(callId);\r\n\r\n\t\t\t\t\tfreeDynamic(already);\r\n\t\t\t\t};\r\n\t\t\t});\r\n\t\t\tpromise.catch(()=>{});//Prevent uncaught error warning\r\n\r\n\r\n\t\t\ttry{\r\n\t\t\t\tconst type=data.readString();\r\n\r\n\t\t\t\tif(type==null)\r\n\t\t\t\t\tthrow RpcTypeNotFoundError.new(null);\r\n\t\t\t\tconst local=registeredTypes.get(type);\r\n\t\t\t\tif(!local)\r\n\t\t\t\t\tthrow RpcTypeNotFoundError.new(type);\r\n\r\n\t\t\t\tconst method=data.readString();\r\n\r\n\t\t\t\tconst args=data.readArray(()=>data.readDynamic(already))??[];\r\n\r\n\r\n\t\t\t\tconst controller=new AbortController();\r\n\t\t\t\tconst context:FunctionCallContext={\r\n\t\t\t\t\ttype,\r\n\t\t\t\t\tmethod,\r\n\t\t\t\t\tget finished(){\r\n\t\t\t\t\t\treturn finished;\r\n\t\t\t\t\t},\r\n\t\t\t\t\tpromise,\r\n\t\t\t\t\tsendMessage(...sending){\r\n\t\t\t\t\t\tif(finished) return context;\r\n\t\t\t\t\t\tconst msg=new DataOutput();\r\n\t\t\t\t\t\tmsg.writeByte(PacketType.MessageToCaller);\r\n\t\t\t\t\t\tmsg.writeLength(callId);\r\n\t\t\t\t\t\tconst list:unknown[]=[];\r\n\t\t\t\t\t\tmsg.writeArray(sending,d=>msg.writeDynamic(d,list));\r\n\t\t\t\t\t\talready.push(...list);\r\n\r\n\t\t\t\t\t\tsendRaw(msg);\r\n\t\t\t\t\t\treturn context;\r\n\t\t\t\t\t},\r\n\t\t\t\t\taddMessageListener(func:(...args:any[])=>void){\r\n\t\t\t\t\t\tregisterReceive(context,func);\r\n\t\t\t\t\t\treturn context;\r\n\t\t\t\t\t},\r\n\t\t\t\t\tcancelToken:controller.signal,\r\n\t\t\t\t\tcancelSelf:()=>controller.abort(),\r\n\t\t\t\t\t[Symbol.asyncIterator]:()=>getAsyncIterator(context),\r\n\t\t\t\t};\r\n\t\t\t\tcurrentlyExecuting.set(callId,context);\r\n\r\n\r\n\t\t\t\tawait invokeForPromise(invoke.bind(null,local,type,method,...args),context,resolve,reject,type,method,args);\r\n\t\t\t}catch(e){\r\n\t\t\t\tif(!(e instanceof RpcError))\r\n\t\t\t\t\te=RpcDataError.new(`Error reading binary stream (${PacketType[packetType]})`,e as Error);\r\n\t\t\t\treject(e as Error);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tcase PacketType.FunctionSuccess:{\r\n\t\t\tconst callId=data.readLength();\r\n\r\n\t\t\tconst pending=activeRequests.get(callId);\r\n\t\t\tif(pending==null){\r\n\t\t\t\tconsole.warn(`[Rpc] No activeRequest[${callId}] (${PacketType[packetType]})`);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\ttry{\r\n\t\t\t\tresolveCall.get(pending)?.(data.readDynamic());\r\n\t\t\t}catch(e){\r\n\t\t\t\trejectCall.get(pending)?.(RpcDataError.new(`Error reading binary stream (${PacketType[packetType]})`,e as Error));\r\n\t\t\t}finally{\r\n\t\t\t\tactiveRequests.delete(callId);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tcase PacketType.FunctionError:{\r\n\t\t\tconst callId=data.readLength();\r\n\r\n\t\t\tconst pending=activeRequests.get(callId);\r\n\t\t\tif(pending==null){\r\n\t\t\t\tconsole.warn(`[Rpc] No activeRequest[${callId}] (${PacketType[packetType]})`);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\ttry{\r\n\t\t\t\tlet err:Error;\r\n\t\t\t\ttry{\r\n\t\t\t\t\terr=data.readError();\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\terr=RpcDataError.new(`Error reading binary stream (${PacketType[packetType]})`,e as Error)\r\n\t\t\t\t}\r\n\t\t\t\tthrow err;\r\n\t\t\t}catch(e){\r\n\t\t\t\trejectCall.get(pending)?.(e);\r\n\t\t\t}finally{\r\n\t\t\t\tactiveRequests.delete(callId);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tcase PacketType.FunctionCancel:{\r\n\t\t\tconst callId=data.readLength();\r\n\t\t\tlet ctx=currentlyExecuting.get(callId);\r\n\t\t\tif(!ctx){\r\n\t\t\t\tconsole.warn(`[Rpc] No currentlyExecuting[${callId}] (${PacketType[packetType]})`);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tctx.cancelSelf();\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tcase PacketType.MessageToExecutor:{\r\n\t\t\tconst callId=data.readLength();\r\n\t\t\tlet ctx=currentlyExecuting.get(callId);\r\n\t\t\tif(!ctx){\r\n\t\t\t\tconsole.warn(`[Rpc] No currentlyExecuting[${callId}] (${PacketType[packetType]})`);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tconst already:unknown[]=[];\r\n\t\t\tconst args=data.readArray(()=>data.readDynamic(already))??[];\r\n\t\t\trunReceiveMessage(ctx,args);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tcase PacketType.MessageToCaller:{\r\n\t\t\tconst callId=data.readLength();\r\n\t\t\tlet pending=activeRequests.get(callId);\r\n\t\t\tif(!pending){\r\n\t\t\t\tconsole.warn(`[Rpc] No activeRequest[${callId}] (${PacketType[packetType]})`);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tconst already:unknown[]=[];\r\n\t\t\tconst args=data.readArray(()=>data.readDynamic(already))??[];\r\n\t\t\trunReceiveMessage(pending,args);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n}","import {RpcError} from \"../RpcError.js\";\r\nimport {readDynamic} from \"./DynamicData.js\";\r\n\r\n// noinspection JSUnusedGlobalSymbols\r\nexport class DataInput{\r\n\tprivate readonly _buf: Uint8Array;\r\n\tprivate readonly _data: DataView;\r\n\tprivate _pos: number;\r\n\tprivate readonly _count: number;\r\n\r\n\tconstructor(buf: Uint8Array);\r\n\tconstructor(buf: Uint8Array,pos: number,length: number);\r\n\tconstructor(buf: Uint8Array,pos: number=0,length: number=buf.length){\r\n\t\tthis._buf=buf;\r\n\t\tthis._data=new DataView(buf.buffer);\r\n\t\tthis._pos=pos;\r\n\t\tthis._count=pos+length;\r\n\t}\r\n\r\n\treadFully(b: number[],off: number=0,len: number=b.length): void{\r\n\t\tlet pos=this._pos;\r\n\t\tconst available=this._count-pos;\r\n\r\n\t\tif(available<len) throw new RangeError(\"not enough bytes available to use readFully\");\r\n\r\n\t\tfor(let i=off; i<off+len; i++)\r\n\t\t\tb[i]=this._buf[pos++]!;\r\n\t\tthis._pos=pos;\r\n\t}\r\n\r\n\tskip(n: number): number{\r\n\t\tlet k=this.available();\r\n\t\tif(n<k) k=n<0?0: n;\r\n\t\tthis._pos+=k;\r\n\t\treturn k;\r\n\t}\r\n\r\n\tavailable(): number{\r\n\t\treturn this._count-this._pos;\r\n\t}\r\n\r\n\treadAll(): Uint8Array{\r\n\t\treturn this._buf.slice(this._pos,this._pos=this._count);\r\n\t}\r\n\r\n\treadBuffer(length: number): Uint8Array{\r\n\t\tif(length>this.available()) throw new RangeError();\r\n\t\treturn this._buf.slice(this._pos,this._pos+=length);\r\n\t}\r\n\r\n\treadByte(): number{\r\n\t\treturn this._data.getUint8(this._pos++);\r\n\t}\r\n\r\n\treadBoolean(): boolean{\r\n\t\treturn this.readByte()!=0;\r\n\t}\r\n\r\n\treadNullBoolean(): boolean | null{\r\n\t\tconst b=this.readByte();\r\n\t\treturn b<2?b==1: null;\r\n\t}\r\n\r\n\treadShort(): number{\r\n\t\tconst n=this._data.getInt16(this._pos);\r\n\t\tthis._pos+=2;\r\n\t\treturn n;\r\n\t}\r\n\r\n\treadUShort(): number{\r\n\t\tconst n=this._data.getUint16(this._pos);\r\n\t\tthis._pos+=2;\r\n\t\treturn n;\r\n\t}\r\n\r\n\treadChar(): string{\r\n\t\treturn String.fromCharCode(this.readUShort());\r\n\t}\r\n\r\n\treadInt(): number{\r\n\t\tconst n=this._data.getInt32(this._pos);\r\n\t\tthis._pos+=4;\r\n\t\treturn n;\r\n\t}\r\n\r\n\treadLong(): bigint{\r\n\t\treturn BigInt(this.readInt())*BigInt(2**32)+BigInt(this.readInt()>>>0);\r\n\t}\r\n\r\n\treadFloat(): number{\r\n\t\tconst n=this._data.getFloat32(this._pos);\r\n\t\tthis._pos+=4;\r\n\t\treturn n;\r\n\t}\r\n\r\n\treadDouble(): number{\r\n\t\tconst n=this._data.getFloat64(this._pos);\r\n\t\tthis._pos+=8;\r\n\t\treturn n;\r\n\t}\r\n\r\n\treadString(): string|null{\r\n\t\tlet length=this.readLength();\r\n\t\tif(length== -1) return null;\r\n\t\treturn new TextDecoder().decode(this.readBuffer(length));\r\n\t}\r\n\r\n\treadLength(): number{\r\n\t\tlet result=0;\r\n\t\tlet push=0;\r\n\t\twhile(true){\r\n\t\t\tconst read=this.readByte();\r\n\t\t\tif(read==0) return push==0?0: ~result;\r\n\t\t\tif((read&0x80)==0){\r\n\t\t\t\tresult|=read<<push;\r\n\t\t\t\treturn result;\r\n\t\t\t}\r\n\t\t\tresult|=(read&0x7f)<<push;\r\n\t\t\tpush+=7;\r\n\t\t}\r\n\t}\r\n\r\n\treadArray<T>(readFunction: ()=>T): T[]|null{\r\n\t\tconst length=this.readLength();\r\n\t\tif(length== -1) return null;\r\n\t\tconst arr: T[]=[];\r\n\t\tfor(let i=0; i<length; i++)\r\n\t\t\tarr[i]=readFunction.call(this);\r\n\t\treturn arr;\r\n\t}\r\n\r\n\treadError(){\r\n\t\treturn RpcError.read(this);\r\n\t}\r\n\r\n\treadDynamic(already: unknown[]=[]){\r\n\t\treturn readDynamic(this,already);\r\n\t}\r\n}","import {RpcName} from \"./RpcName.js\";\r\nimport {disposeConnection,receiveRpc} from \"./Connection.js\";\r\nimport {DataInput} from \"../types/data/DataInput.js\";\r\nimport {callRemoteFunction} from \"../types/functions/FunctionCallContext.js\";\r\nimport {registeredTypes} from \"../internal/RegisteredTypes.js\";\r\nimport {isNodeJs,RpcId} from \"./RpcId.js\";\r\nimport {RpcConnectionError} from \"../types/errors/PredefinedErrors.js\";\r\nimport {Rpc} from \"../rpc.js\";\r\n\r\n\r\nexport let isConnected=false;\r\n\r\n\r\nlet resolveWaitUntilConnected:VoidFunction,rejectWaitUntilConnected:(e:Error)=>void;\r\nlet waitUntilConnectedAttempt=new Promise<void>((res,rej)=>[resolveWaitUntilConnected,rejectWaitUntilConnected]=[res,rej]);\r\nwaitUntilConnectedAttempt.catch(()=>{});//Prevent uncaught error warning\r\n\r\nexport async function waitConnected(){\r\n\twhile(true)\r\n\t\tif(await waitUntilConnectedAttempt.then(()=>true,()=>false))\r\n\t\t\treturn;\r\n}\r\n\r\nlet createWebSocket:(query:URLSearchParams)=>Promise<WebSocket>;\r\nif(isNodeJs){\r\n\tconst RPC_URL=\"RPC_URL\" in globalThis?(globalThis as any)[\"RPC_URL\"]:process.env.RPC_URL;\r\n\tconst RPC_TOKEN=\"RPC_TOKEN\" in globalThis?(globalThis as any)[\"RPC_TOKEN\"]:process.env.RPC_TOKEN;\r\n\tif(!RPC_URL){\r\n\t\tconsole.warn(\"[Rpc] RPC_URL is not defined => RPC will not connect\");\r\n\t\tcreateWebSocket=async()=>({} as any as WebSocket);\r\n\t}else\r\n\t\tcreateWebSocket=async(query)=>{\r\n\t\t\tconst uri=new URL(RPC_URL);\r\n\t\t\turi.search=query.toString();\r\n\t\t\tconst ws:typeof import(\"ws\").WebSocket=\"require\" in globalThis?globalThis[\"require\"](\"ws\"):(await import(\"ws\")).WebSocket;\r\n\r\n\t\t\treturn new ws(uri,RPC_TOKEN==null?{}:{\r\n\t\t\t\theaders:{\r\n\t\t\t\t\tCookie:\"RPC_TOKEN=\"+RPC_TOKEN,\r\n\t\t\t\t},\r\n\t\t\t}) as unknown as WebSocket;\r\n\t\t};\r\n}else if(\"document\" in globalThis)\r\n\tcreateWebSocket=async(query)=>new WebSocket(\"ws\"+document.location.origin.substring(4)+\"/rpc?\"+query);\r\nelse{//Unknown Platform\r\n\tconst RPC_URL=\"RPC_URL\" in globalThis?(globalThis as any)[\"RPC_URL\"]:process.env.RPC_URL;\r\n\tconst RPC_TOKEN=\"RPC_TOKEN\" in globalThis?(globalThis as any)[\"RPC_TOKEN\"]:process.env.RPC_TOKEN;\r\n\tif(!RPC_URL){\r\n\t\tconsole.warn(\"[Rpc] RPC_URL is not defined => RPC will not connect\");\r\n\t\tcreateWebSocket=async()=>({} as any as WebSocket);\r\n\t}else\r\n\t\tcreateWebSocket=async(query)=>{\r\n\t\t\tconst uri=new URL(RPC_URL);\r\n\t\t\turi.search=query.toString();\r\n\t\t\treturn new WebSocket(uri,RPC_TOKEN==null?{}:{\r\n\t\t\t\theaders:{\r\n\t\t\t\t\tCookie:\"RPC_TOKEN=\"+RPC_TOKEN,\r\n\t\t\t\t},\r\n\t\t\t} as any) as unknown as WebSocket;\r\n\t\t};\r\n}\r\n\r\n\r\nfunction closeRpc(e:Error){\r\n\tconst reject=rejectWaitUntilConnected;\r\n\twaitUntilConnectedAttempt=new Promise<void>((res,rej)=>[resolveWaitUntilConnected,rejectWaitUntilConnected]=[res,rej]);\r\n\twaitUntilConnectedAttempt.catch(()=>{});//Prevent uncaught error warning\r\n\treject(e);\r\n\r\n\tdisposeConnection(e);\r\n}\r\n\r\n\r\n//connect\r\n\r\n\r\nexport let _webSocket:WebSocket | null=null;\r\n\r\n\r\nexport async function connectOnce(reconnect:VoidFunction){\r\n\tlet reportedName=RpcName;\r\n\tlet reportedTypes=new Set<string>();\r\n\r\n\tconst query=new URLSearchParams();\r\n\tquery.set(\"id\",RpcId);\r\n\treportedTypes.add(\"$\"+RpcId);\r\n\r\n\tif(reportedName!=null)\r\n\t\tquery.set(\"name\",reportedName);\r\n\r\n\tfor(let key of registeredTypes.keys())\r\n\t\tif(!reportedTypes.has(key)){\r\n\t\t\treportedTypes.add(key);\r\n\t\t\tquery.append(\"type\",key);\r\n\t\t}\r\n\r\n\r\n\tconst webSocket=await createWebSocket(query);\r\n\r\n\twebSocket.onclose=()=>{\r\n\t\tsetTimeout(reconnect,1000);\r\n\r\n\t\tif(!_webSocket) return;\r\n\t\t_webSocket=null;\r\n\t\tisConnected=false;\r\n\t\tconsole.info(\"[Rpc] Reconnecting to RPC\");\r\n\t\tcloseRpc(RpcConnectionError.new(\"Connection closed by \"+Rpc.prettyName));\r\n\t};\r\n\twebSocket.onopen=async()=>{\r\n\t\tconsole.info(\"[Rpc] Connected to RPC\");\r\n\r\n\t\ttry{\r\n\t\t\t_webSocket=webSocket;\r\n\r\n\t\t\tconst toRegister=new Set(registeredTypes.keys());\r\n\t\t\tconst toDelete=new Set(reportedTypes);\r\n\r\n\t\t\tfor(let type of toRegister)\r\n\t\t\t\tif(toDelete.delete(type))\r\n\t\t\t\t\ttoRegister.delete(type);\r\n\r\n\t\t\tif(toRegister.size||toDelete.size)\r\n\t\t\t\tif(RpcName!=reportedName) await callRemoteFunction(null,\"H\",RpcName,[...toRegister.keys()],[...toDelete.keys()]);\r\n\t\t\t\telse await callRemoteFunction(null,\"H\",[...toRegister.keys()],[...toDelete.keys()]);\r\n\t\t\telse if(RpcName!=reportedName) await callRemoteFunction(null,\"H\",RpcName);\r\n\r\n\t\t\tisConnected=true;\r\n\t\t\tresolveWaitUntilConnected();\r\n\r\n\t\t\t// @ts-ignore\r\n\t\t}catch(e:Error){\r\n\t\t\tconsole.error(\"[Rpc] Error connecting to RPC: \",e);\r\n\t\t\tcloseRpc(e);\r\n\r\n\t\t\twebSocket?.close(4000,\"Error registering types\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t};\r\n\r\n\twebSocket.binaryType=\"arraybuffer\";\r\n\twebSocket.onmessage=(e:MessageEvent)=>{\r\n\t\tconst data=e.data;\r\n\t\tif(typeof data==\"string\") console.log(\"[Rpc] WebSocket Message:\",data);\r\n\t\telse receiveRpc(new DataInput(new Uint8Array(data)))\r\n\t\t\t.catch(e=>console.warn(\"[Rpc] Error receiving Packet:\",e));\r\n\t};\r\n}\r\n\r\n(async function connectLoop(){\r\n\tawait Promise.resolve();//Moves from main into the event loop\r\n\r\n\t// noinspection InfiniteLoopJS\r\n\twhile(true)\r\n\t\tawait new Promise<void>(\r\n\t\t\tresolve=>connectOnce(resolve));\r\n}());\r\n","import {isConnected} from \"./WebSocketConnection.js\";\r\nimport {callRemoteFunction} from \"../types/functions/FunctionCallContext.js\";\r\n\r\n\r\nexport let RpcName:string|null=null;\r\n\r\nexport async function setName(name:string|null){\r\n\tRpcName=name;\r\n\ttry{\r\n\t\tif(isConnected) await callRemoteFunction(null,'N',name);\r\n\t}catch(e){\r\n\t\tconsole.error(`[Rpc] Error changing name to \"${name}\":`,e);\r\n\t}\r\n}","import {DataOutput} from \"./DataOutput.js\";\r\nimport {DataInput} from \"./DataInput.js\";\r\nimport {readRegistry,writeRegistry} from \"./DynamicData.js\";\r\n\r\n\r\ninterface CustomDynamicTypeInstance{\r\n\twrite(outgoing:DataOutput,already:unknown[]):void;\r\n}\r\n\r\ninterface CustomDynamicType<T extends CustomDynamicTypeInstance>{\r\n\tnew(...arg: any[]):T;\r\n\tread(incoming:DataInput,already:unknown[]):CustomDynamicTypeInstance;\r\n}\r\n\r\nexport function CustomDynamicType(id: string){\r\n\treturn function<T extends CustomDynamicTypeInstance>(target: CustomDynamicType<T>){\r\n\t\twriteRegistry.push([id,d=>d instanceof target,(data,o,already)=>(o as T).write(data,already)]);\r\n\t\treadRegistry.set(id,(data,already)=>target.read(data,already));\r\n\t};\r\n}","import {registerType} from \"../internal/RegisteredTypes.js\";\r\n\r\nexport function RpcProvider(type?: string){\r\n\treturn (target: any)=>void registerType(type??target.prototype.constructor.name,target);\r\n}\r\n","import {RpcName,setName} from \"./connection/RpcName.js\";\r\nimport {isConnected,waitConnected} from \"./connection/WebSocketConnection.js\";\r\nimport {\r\n\tcreateRemoteObject,\r\n\tRPC_ROOT,\r\n\tRpcObject,\r\n\tRpcObjectExists,\r\n\tRpcObjectGetMethods,\r\n\tRpcObjectType,\r\n} from \"./types/RpcObject.js\";\r\nimport {registerFunction,RpcFunction,unregisterFunction} from \"./types/RpcFunction.js\";\r\nimport {\r\n\tcallLocal,\r\n\tcallRemoteFunction,\r\n\tFunctionCallContext,\r\n\tgetFunctionContext,\r\n\trunWithContext,\r\n} from \"./types/functions/FunctionCallContext.js\";\r\nimport {generateTypeName,registerType,unregisterType} from \"./internal/RegisteredTypes.js\";\r\nimport {RpcId} from \"./connection/RpcId.js\";\r\nimport {PendingCall} from \"./types/functions/PendingCall.js\";\r\n\r\n\r\nexport * from \"./types/data/DataInput.js\";\r\nexport * from \"./types/data/DataOutput.js\";\r\nexport {CustomDynamicType} from \"./types/data/CustomDynamicTypeDecorator.js\";\r\n\r\nexport type {FunctionCallContext} from \"./types/functions/FunctionCallContext.js\";\r\nexport * from \"./types/functions/PendingCall.js\";\r\n\r\nexport * from \"./types/RpcObject.js\";\r\nexport * from \"./types/RpcFunction.js\";\r\nexport * from \"./types/RpcError.js\";\r\nexport {RpcCustomError} from \"./types/errors/RpcCustomErrorDecorator.js\";\r\nexport * from \"./types/errors/PredefinedErrors.js\";\r\nexport {RpcProvider} from \"./types/RpcProviderDecorator.js\";\r\n\r\nimport(\"./rpc.js\").then((m)=>Object.assign(globalThis,m));\r\n\r\n// noinspection JSUnusedGlobalSymbols\r\nexport class Rpc{\r\n\r\n\t//Rpc\r\n\tpublic static readonly id:string=RpcId;\r\n\r\n\tpublic static get prettyName():string{\r\n\t\treturn Rpc.name!=null?`${Rpc.name} (${Rpc.id})`:Rpc.id;\r\n\t}\r\n\r\n\tpublic static get name():string | null{\r\n\t\treturn RpcName;\r\n\t}\r\n\t\r\n\tpublic static setName=setName;\r\n\r\n\t//Connection\r\n\tpublic static get isConnected():boolean{\r\n\t\treturn isConnected;\r\n\t}\r\n\r\n\tpublic static get waitUntilConnected():Promise<void>{\r\n\t\treturn waitConnected();\r\n\t}\r\n\r\n\t//Functions\r\n\tpublic static createObject=createRemoteObject;\r\n\tpublic static createFunction=<T>(type:string,method:string)=>new RpcFunction<T>(type,method);\r\n\tpublic static registerFunction=registerFunction;\r\n\tpublic static unregisterFunction=unregisterFunction;\r\n\r\n\tpublic static callLocal=callLocal;//Call function and get a PendingCall, this allows the use of the FunctionCallContext within the function\r\n\tpublic static callFunction=callRemoteFunction;//Call remote function\r\n\r\n\tpublic static getContext:()=>FunctionCallContext=getFunctionContext;\r\n\tpublic static runWithContext=runWithContext;\r\n\r\n\t//Types\r\n\tpublic static registerType=registerType;\r\n\tpublic static unregisterType=unregisterType;\r\n\tpublic static generateTypeName=generateTypeName;\r\n\t\r\n\r\n\tpublic static getObjectWithFallback=async(type:string,...types:string[]):Promise<number>=>await callRemoteFunction(\"Rpc\",\"getObjectWithFallback\",type,...types);\r\n\tpublic static checkTypes=async(...types:string[]):Promise<number>=>await callRemoteFunction(\"Rpc\",\"checkTypes\",...types);\r\n\tpublic static checkType=async(type:string):Promise<boolean>=>await callRemoteFunction(\"Rpc\",\"checkType\",type);\r\n\tpublic static getAllTypes=async():Promise<string[]>=>await callRemoteFunction(\"Rpc\",\"getAllTypes\");\r\n\tpublic static getAllConnections=async():Promise<string[]>=>await callRemoteFunction(\"Rpc\",\"getAllConnections\");\r\n\tpublic static getRegistrations=async(includeHidden:boolean=false):Promise<(Record<string,string[]>)>=>await callRemoteFunction(\"Rpc\",\"getRegistrations\",includeHidden);\r\n\tpublic static evalObject=async(expression:string):Promise<any>=>await callRemoteFunction(\"Rpc\",\"evalObject\",expression);\r\n\tpublic static evalString=async(expression:string):Promise<string>=>await callRemoteFunction(\"Rpc\",\"evalString\",expression);\r\n\tpublic static listenCalls=():PendingCall=>callRemoteFunction(\"Rpc\",\"listenCalls\");\r\n\r\n\tpublic static root=RPC_ROOT;\r\n\t\r\n\tpublic static getObjectMethods=(o:RpcObject|string)=>(typeof o===\"string\"?createRemoteObject(o):o)[RpcObjectGetMethods]();\r\n\tpublic static getObjectExists=(o:RpcObject|string)=>(typeof o===\"string\"?createRemoteObject(o):o)[RpcObjectExists]();\r\n\tpublic static getObjectType=(o:RpcObject)=>o[RpcObjectType];\r\n\tpublic static getMethodSignatures=(type:string,method:string,ts=false)=>new RpcFunction(type,method).getMethodSignatures(ts);\r\n}\r\n\r\n\r\n//import \"./_test/webTest.js\""],"names":["RpcCustomErrors","RpcCustomError","typeTag","target","tagToError","errorToTag","__name","root","factory","module","this","_isNumber","n","_capitalize","str","_getter","p","booleanProps","numericProps","stringProps","arrayProps","objectProps","props","StackFrame","obj","i","v","fileName","lineNumber","columnNumber","functionName","argsStartIndex","argsEndIndex","args","locationString","parts","j","k","require$$0","FIREFOX_SAFARI_STACK_REGEXP","CHROME_IE_STACK_REGEXP","SAFARI_NATIVE_CODE_REGEXP","error","urlLike","regExp","filtered","line","sanitizedLine","location","locationParts","functionNameRegex","matches","e","lineRE","lines","result","len","match","tokens","functionCall","argsRaw","fixString","s","framesToString","frames","frame","causeToString","cause","RpcError","ErrorStackParser","removeFromStackTrace","ownStack","#ownStack","#stackTrace","#causes","#appendStack","from","message","stackTrace","data","Rpc","causeIndex","trace","output","input","type","constructor","stackSource","skip","method","a","isNodeJs","chars","randomId","RpcId","quoted","RpcCallError","RpcTypeNotFoundError","__publicField","__decorateClass","RpcMethodNotFoundError","RpcMetaMethodNotFoundError","meta","RpcConnectionError","RpcEvalError","RpcDataError","getFunctionParameterNames","func","code","identifier","end","registeredFunctions","registeredTypes","generateTypeName","registerType","invoker","isConnected","callRemoteFunction","unregisterType","invoke","ignoreCase","getMethods","reference","getMethodSignatures","ts","getter","RpcObjectGetMethodSignatures","RpcObjectGetMethods","key","PendingCall","dispose","resolve","reject","resolveCall","t","rejectCall","freeDynamic","onrejected","onfinally","onfulfilled","_args","registerReceive","getAsyncIterator","call","didReceive","waitReceive","request","res","pendingMap","listenersMap","pendings","pending","runReceiveMessage","currentContext","runWithContext","context","previous","getFunctionContext","nextId","local","callLocalFunction","already","buff","DataOutput","callId","PacketType","d","_webSocket","msgArgs","msg","list","sendRaw","sendCall","callLocal","controller","sending","received","invokeForPromise","RpcFunction","typeScript","functionCache","registerFunction","id","unregisterFunction","RpcObjectType","RpcObjectExists","createRemoteObject","cache","_","argArray","RPC_ROOT","prop","writeRegistry","readRegistry","readDynamic","objectId","o","registryEntry","pattern","flags","objectType","writeDynamic","rpcFunc","onFree","buffer","element","check","write","idBytes","entries","value","size","additional","replacement","b","buf","c","array","u","arr","writeFunction","activeRequests","currentlyExecuting","disposeConnection","ctx","receiveRpc","packetType","finished","promise","rej","err","DataInput","pos","length","off","push","read","readFunction","resolveWaitUntilConnected","rejectWaitUntilConnected","waitUntilConnectedAttempt","waitConnected","createWebSocket","RPC_URL","RPC_TOKEN","query","uri","ws","closeRpc","connectOnce","reconnect","reportedName","RpcName","reportedTypes","webSocket","toRegister","toDelete","setName","name","CustomDynamicType","RpcProvider","rpc","m","types","includeHidden","expression"],"mappings":"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","x_google_ignoreList":[1,2]}