"use strict";var We=Object.create;var ye=Object.defineProperty;var Ge=Object.getOwnPropertyDescriptor;var qe=Object.getOwnPropertyNames;var ze=Object.getPrototypeOf,Ve=Object.prototype.hasOwnProperty;var He=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of qe(e))!Ve.call(t,i)&&i!==r&&ye(t,i,{get:()=>e[i],enumerable:!(n=Ge(e,i))||n.enumerable});return t};var Je=(t,e,r)=>(r=t!=null?We(ze(t)):{},He(e||!t||!t.__esModule?ye(r,"default",{value:t,enumerable:!0}):r,t));Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const oe=[new Map,new Map];function $(t){return function(e){const[r,n]=oe;r.set(t,e),n.set(e,t)}}var ve=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Xe(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Ce={exports:{}},se={exports:{}},me;function Qe(){return me||(me=1,function(t,e){(function(r,n){t.exports=n()})(ve,function(){function r(u){return!isNaN(parseFloat(u))&&isFinite(u)}function n(u){return u.charAt(0).toUpperCase()+u.substring(1)}function i(u){return function(){return this[u]}}var s=["isConstructor","isEval","isNative","isToplevel"],a=["columnNumber","lineNumber"],c=["fileName","functionName","source"],o=["args"],w=["evalOrigin"],l=s.concat(a,c,o,w);function f(u){if(u)for(var d=0;d<l.length;d++)u[l[d]]!==void 0&&this["set"+n(l[d])](u[l[d]])}f.prototype={getArgs:function(){return this.args},setArgs:function(u){if(Object.prototype.toString.call(u)!=="[object Array]")throw new TypeError("Args must be an Array");this.args=u},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(u){if(u instanceof f)this.evalOrigin=u;else if(u instanceof Object)this.evalOrigin=new f(u);else throw new TypeError("Eval Origin must be an Object or StackFrame")},toString:function(){var u=this.getFileName()||"",d=this.getLineNumber()||"",v=this.getColumnNumber()||"",K=this.getFunctionName()||"";return this.getIsEval()?u?"[eval] ("+u+":"+d+":"+v+")":"[eval]:"+d+":"+v:K?K+" ("+u+":"+d+":"+v+")":u+":"+d+":"+v}},f.fromString=function(d){var v=d.indexOf("("),K=d.lastIndexOf(")"),Be=d.substring(0,v),je=d.substring(v+1,K).split(","),we=d.substring(K+1);if(we.indexOf("@")===0)var ie=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(we,""),De=ie[1],Ue=ie[2],Ke=ie[3];return new f({functionName:Be,args:je||void 0,fileName:De,lineNumber:Ue||void 0,columnNumber:Ke||void 0})};for(var h=0;h<s.length;h++)f.prototype["get"+n(s[h])]=i(s[h]),f.prototype["set"+n(s[h])]=function(u){return function(d){this[u]=!!d}}(s[h]);for(var g=0;g<a.length;g++)f.prototype["get"+n(a[g])]=i(a[g]),f.prototype["set"+n(a[g])]=function(u){return function(d){if(!r(d))throw new TypeError(u+" must be a Number");this[u]=Number(d)}}(a[g]);for(var p=0;p<c.length;p++)f.prototype["get"+n(c[p])]=i(c[p]),f.prototype["set"+n(c[p])]=function(u){return function(d){this[u]=String(d)}}(c[p]);return f})}(se)),se.exports}(function(t,e){(function(r,n){t.exports=n(Qe())})(ve,function(n){var i=/(^|@)\S+:\d+/,s=/^\s*at .*(\S+:\d+|\(native\))/m,a=/^(eval@)?(\[native code])?$/;return{parse:function(o){if(typeof o.stacktrace<"u"||typeof o["opera#sourceloc"]<"u")return this.parseOpera(o);if(o.stack&&o.stack.match(s))return this.parseV8OrIE(o);if(o.stack)return this.parseFFOrSafari(o);throw new Error("Cannot parse given Error object")},extractLocation:function(o){if(o.indexOf(":")===-1)return[o];var w=/(.+?)(?::(\d+))?(?::(\d+))?$/,l=w.exec(o.replace(/[()]/g,""));return[l[1],l[2]||void 0,l[3]||void 0]},parseV8OrIE:function(o){var w=o.stack.split(`
`).filter(function(l){return!!l.match(s)},this);return w.map(function(l){l.indexOf("(eval ")>-1&&(l=l.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var f=l.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),h=f.match(/ (\(.+\)$)/);f=h?f.replace(h[0],""):f;var g=this.extractLocation(h?h[1]:f),p=h&&f||void 0,u=["eval","<anonymous>"].indexOf(g[0])>-1?void 0:g[0];return new n({functionName:p,fileName:u,lineNumber:g[1],columnNumber:g[2],source:l})},this)},parseFFOrSafari:function(o){var w=o.stack.split(`
`).filter(function(l){return!l.match(a)},this);return w.map(function(l){if(l.indexOf(" > eval")>-1&&(l=l.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),l.indexOf("@")===-1&&l.indexOf(":")===-1)return new n({functionName:l});var f=/((.*".+"[^@]*)?[^@]*)(?:@)/,h=l.match(f),g=h&&h[1]?h[1]:void 0,p=this.extractLocation(l.replace(f,""));return new n({functionName:g,fileName:p[0],lineNumber:p[1],columnNumber:p[2],source:l})},this)},parseOpera:function(o){return!o.stacktrace||o.message.indexOf(`
`)>-1&&o.message.split(`
`).length>o.stacktrace.split(`
`).length?this.parseOpera9(o):o.stack?this.parseOpera11(o):this.parseOpera10(o)},parseOpera9:function(o){for(var w=/Line (\d+).*script (?:in )?(\S+)/i,l=o.message.split(`
`),f=[],h=2,g=l.length;h<g;h+=2){var p=w.exec(l[h]);p&&f.push(new n({fileName:p[2],lineNumber:p[1],source:l[h]}))}return f},parseOpera10:function(o){for(var w=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,l=o.stacktrace.split(`
`),f=[],h=0,g=l.length;h<g;h+=2){var p=w.exec(l[h]);p&&f.push(new n({functionName:p[3]||void 0,fileName:p[2],lineNumber:p[1],source:l[h]}))}return f},parseOpera11:function(o){var w=o.stack.split(`
`).filter(function(l){return!!l.match(i)&&!l.match(/^Error created at/)},this);return w.map(function(l){var f=l.split("@"),h=this.extractLocation(f.pop()),g=f.shift()||"",p=g.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0,u;g.match(/\(([^)]*)\)/)&&(u=g.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var d=u===void 0||u==="[arguments not available]"?void 0:u.split(",");return new n({functionName:p,args:d,fileName:h[0],lineNumber:h[1],columnNumber:h[2],source:l})},this)}}})})(Ce);var Ye=Ce.exports;const J=Xe(Ye);function ae(t){return t.replaceAll("\r","").replaceAll(/^\n+|\n+$/g,"").replaceAll(/^  +/gm,"	")}function X(t){let e="";for(let r of t){if(r.functionName?.includes("$RPC_MARKER_BEGIN$"))break;e+=`
	at `+r}return e}function Se(t){return t===void 0?"":t instanceof m?`
caused by: `+t.toString():t instanceof Error?`
caused by: `+ae(t.toString())+X(J.parse(t))+Se(t.cause):`
caused by: `+ae(t?.toString()??"null")}function Ne(t,e){return(t===m||Ne(t.__proto__,e))&&e[0].functionName?.replace(/^new /,"")===t.name?(e.shift(),!0):!1}class m extends Error{from;data={};_ownStack=[];get stackTrace(){let e=this._stackTrace;return e+=X(this._ownStack),e+=this._causes,e.replaceAll(/^\n+/g,"")}_stackTrace="";_appendStack=!1;_causes="";constructor(...e){let r=null,n=null,i=null,s={},a;switch(e.length){case 1:[n]=e;break;case 2:[n,a]=e;break;case 4:[n,r,n,i]=e;break;case 5:e[4]instanceof m?[n,r,n,i,a]=e:[n,r,n,i,s]=e;break;case 6:[n,r,n,i,s,a]=e;break;default:throw new Error("Invalid arg count")}a!=null?super(n??void 0,{cause:a}):super(n??void 0),this.name=this.constructor.name,this.from=r??b.prettyName;const c=oe[1].get(this.constructor);if(c!=null&&(this.data.$type=c),Object.assign(this.data,s??{}),i==null)this._appendStack=!0,this._ownStack=J.parse(this),Ne(this.constructor,this._ownStack);else{this._stackTrace=`
`+ae(i);const o=this._stackTrace.indexOf(`
caused by: `);o!=-1&&(this._causes+=this._stackTrace.substring(o),this._stackTrace=this._stackTrace.substring(0,o))}this._causes+=Se(a),this.stack=this.toString()}toString(){let e=this.name+"("+this.from+")";this.message?.trim()&&(e+=": "+this.message);const r=this.stackTrace;return r?.trim()&&(e+=`
`+r),e}write(e){e.writeString(this.name),e.writeString(this.from),e.writeString(this.message),e.writeString(this.stackTrace),e.writeString(Object.keys(this.data).length==0?null:JSON.stringify(this.data))}static read(e){const r=e.readString(),n=e.readString()??"???",i=e.readString(),s=e.readString()??"";let a;try{a=JSON.parse(e.readString()??"null")}catch(c){if(c instanceof RangeError)a={$info:"JsonData was not included, due to an old PlayifyRpc version"};else throw c}return m.create(r,n,i,s,a)}static create(e,r,n,i,s){const a=s?.$type,c=oe[0].get(a)??m;return new c(e,r,n,i,s)}static wrapAndFreeze(e){return e instanceof m?(e._appendStack&&(e._appendStack=!1,e._stackTrace+=X(e._ownStack),e._ownStack=[],e.stack=e.toString()),e):new m(e.name,e instanceof m?e.from:null,e.message,X(J.parse(e)).substring(1),{},e.cause)}unfreeze(e,r){return this._appendStack?this:(this._appendStack=!0,this._ownStack=J.parse(e).slice(r),this.stack=this.toString(),this)}append(e,r,n){return this._stackTrace+=`
	rpc `+(n==null?"<<callLocal>>":(e??"<<null>>")+"."+(r??"<<null>>")+"("+n.map(i=>JSON.stringify(i)).join(",")+")"),this.stack=this.toString(),this}}const Oe=globalThis?.process?.versions?.node!=null,be="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",Re=()=>Date.now().toString(36)+Array(10).fill(void 0).map(()=>be[Math.floor(Math.random()*be.length)]).join("");let R;if(Oe)try{process?.versions.bun?R="bun@"+require("os").hostname()+"@"+process.pid:R="node@"+process.binding("os").getHostname()+"@"+process.pid}catch{R="node-alternative@"+process.platform+":"+process.arch+"@"+process.pid}else"document"in globalThis?R="web@"+document.location+"#"+Re():R="js@"+Re();var Te=Object.defineProperty,Ze=Object.getOwnPropertyDescriptor,et=(t,e,r)=>e in t?Te(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,q=(t,e,r,n)=>{for(var i=n>1?void 0:n?Ze(e,r):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=(n?a(e,r,i):a(i))||i);return n&&i&&Te(e,r,i),i},ee=(t,e,r)=>(et(t,typeof e!="symbol"?e+"":e,r),r);const W=t=>t==null?"null":'"'+t+'"';class U extends m{}exports.RpcTypeNotFoundError=class extends U{};ee(exports.RpcTypeNotFoundError,"new",t=>new exports.RpcTypeNotFoundError(null,null,`Type ${W(t)} does not exist`,"",{type:t}));exports.RpcTypeNotFoundError=q([$("$type")],exports.RpcTypeNotFoundError);exports.RpcMethodNotFoundError=class extends U{};ee(exports.RpcMethodNotFoundError,"new",(t,e)=>new exports.RpcMethodNotFoundError(null,null,`Method ${W(e)} does not exist on type ${W(t)}`,"",{type:t,method:e}));exports.RpcMethodNotFoundError=q([$("$method")],exports.RpcMethodNotFoundError);exports.RpcMetaMethodNotFoundError=class extends exports.RpcMethodNotFoundError{};ee(exports.RpcMetaMethodNotFoundError,"new",(t,e)=>new exports.RpcMetaMethodNotFoundError(null,null,`Meta-Method ${W(e)} does not exist on type ${W(t)}`,"",{type:t,method:null,meta:e}));exports.RpcMetaMethodNotFoundError=q([$("$method-meta")],exports.RpcMetaMethodNotFoundError);exports.RpcConnectionError=class extends U{};ee(exports.RpcConnectionError,"new",t=>new exports.RpcConnectionError(null,null,t,""));exports.RpcConnectionError=q([$("$connection")],exports.RpcConnectionError);exports.RpcEvalError=class extends U{};exports.RpcEvalError=q([$("$eval")],exports.RpcEvalError);const he=Object.create(null),_=new Map;_.set("$"+R,he);async function Fe(t,e){if(!_.has(t)){_.set(t,e);try{x&&await y(null,"+",t)}catch(r){console.warn(r),_.delete(t)}}}async function tt(t){if(_.has(t)){try{x&&await y(null,"-",t)}catch(e){console.warn(e)}_.delete(t)}}async function Ee(t){const e=t[D];return e?await e.call(t):Object.getOwnPropertyNames(t).filter(r=>typeof t[r]=="function")}async function Me(t,e,r,...n){if(r!=null){let s=t[r];if(s==null){let c=(await Ee(t)).find(o=>o.toLowerCase()==r.toLowerCase());c!=null&&(s=t[c])}const a={}[r];if(s==null||s===a)throw exports.RpcMethodNotFoundError.new(e,r);try{return await{async $RPC_MARKER_BEGIN$(){return await s.call(t,...n)}}.$RPC_MARKER_BEGIN$()}catch(c){throw m.wrapAndFreeze(c)}}const i=n.length==0?null:n[0];switch(i){case"M":return Ee(t);default:throw exports.RpcMetaMethodNotFoundError.new(e,i)}}class te{[Symbol.toStringTag]="PendingCall";finished=!1;promise;constructor(e,r){try{throw new Error}catch(n){this.promise=new Promise((i,s)=>{k.set(this,a=>{k.delete(this),E.delete(this),this.finished=!0,i(a),Y(r)}),E.set(this,a=>{k.delete(this),E.delete(this),this.finished=!0,s(a instanceof m?a.unfreeze(n,e):a),Y(r)})})}}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}then(e,r){return this.promise.then(e,r)}sendMessage(...e){return this}addMessageListener(e){return V(this,e)}cancel(){}[Symbol.asyncIterator](){return z(this)}}function z(t){let e=[],r=[];return t.promise.catch(()=>{}),t.promise.finally(()=>{for(let n of r)n({done:!0,value:void 0})}),t.addMessageListener((...n)=>{(r.shift()??e.push)({done:!1,value:n})}),{async next(){return t.finished?{done:!0,value:void 0}:e.shift()??await new Promise(n=>r.push(n))}}}const k=new WeakMap,E=new WeakMap,M=new WeakMap,L=new WeakMap;function V(t,e){if(L.has(t))L.get(t).push(e);else{L.set(t,[e]);const r=M.get(t)??[];for(let n of r)try{e(...n)}catch(i){console.warn("Error receiving pending: ",i)}}return t}function j(t,e){if(!t.finished)if(L.has(t))for(let r of L.get(t))try{r(...e)}catch(n){console.warn("Error receiving: ",n)}else M.has(t)?M.set(t,[...M.get(t),e]):M.set(t,[e])}let N=null;function rt(t,e){const r=N;N=e;try{return t()}finally{N=r}}function nt(){if(N==null)throw new Error("FunctionCallContext not available");return N}let it=0;function y(t,e,...r){if(t!=null){const c=_.get(t);if(c)return ke(Me.bind(null,c,t,e,...r),t,e,r,3)}const n=[],i=new te(2,n),s=new T,a=it++;try{s.writeByte(Q.FunctionCall),s.writeLength(a),s.writeString(t),s.writeString(e),s.writeArray(r,c=>s.writeDynamic(c,n))}catch(c){return E.get(i)?.(c),i}return x||t==null&&B!=null?(i.sendMessage=(...c)=>{if(i.finished)return i;const o=new T;o.writeByte(Q.MessageToExecutor),o.writeLength(a);const w=[];return o.writeArray(c,l=>o.writeDynamic(l,w)),n.push(...w),I(o),i},i.cancel=()=>{if(i.finished)return;const c=new T;c.writeByte(Q.FunctionCancel),c.writeLength(a),I(c)},ct(a,i,s),i):(E.get(i)?.(exports.RpcConnectionError.new("Not connected")),i)}function st(t){return ke(t,null,null,null,3)}function ke(t,e,r,n,i){const s=new te(i,[]),a=new AbortController,c={type:e,method:r,sendMessage:(...o)=>(s.finished||j(s,o),c),get finished(){return s.finished},promise:s,addMessageListener:o=>V(c,o),cancelToken:a.signal,cancelSelf:()=>a.abort(),[Symbol.asyncIterator]:()=>z(c)};return s.sendMessage=(...o)=>(s.finished||j(c,o),s),s.cancel=()=>s.finished||c.cancelSelf(),Le(t,c,k.get(s),E.get(s),e,r,n),s}async function Le(t,e,r,n,i,s,a){try{let c;const o=N;N=e;try{c=await{async $RPC_MARKER_BEGIN$(){return await t()}}.$RPC_MARKER_BEGIN$()}finally{N=o}r?.(await c)}catch(c){n?.(m.wrapAndFreeze(c).append(i,s,a))}}const C=class extends function(r){return Object.setPrototypeOf(r,new.target.prototype)}{constructor(e,r){super(y.bind(null,e,r)),this.type=e,this.method=r}toString(){return`rpc (...params) => ${this.type??"null"}.${this.method}(...params)`}};let ot=Date.now();const ce=new WeakMap;function re(t){if(t instanceof C)return t;const e=ce.get(t);if(e!=null)return new C("$"+R,e);const r=(ot++).toString(16);he[r]=t,ce.set(t,r);const n="$"+R;return new C(n,r)}function ne(t){const e="$"+R;if(t.type!=e)throw new Error("Can't unregister RemoteFunction, that was not registered locally");delete he[t.method],ce.delete(t)}const O=Symbol("RpcObjectType"),G=Symbol("RpcObjectExists"),D=Symbol("RpcObjectGetMethods");function H(t,e=new class{[O]=t}){const r=new Map;return new Proxy(e,{get(n,i){if(i==O)return t;if(i==G)return()=>y(null,"E",t);if(i==D)return()=>y(t,null,"M");if(typeof i!="string"||i=="then")return e[i];if(r.has(i))return r.get(i);const s=new C(t,i);return r.set(i,s),s},construct(n,i){return new n(...i)},has(n,i){return i==O||i==D||i==G||i in e}})}const ge=new Proxy({},{get:(t,e)=>typeof e=="string"?H(e):void 0,has:(t,e)=>typeof e=="string"&&e!="then"}),xe=[],$e=new Map;function le(t,e){let r=t.readLength();if(r<0){switch(r=-r,r%4){case 0:return e[r/4];case 1:return new TextDecoder().decode(t.readBuffer((r-1)/4));case 2:{const n={};e.push(n);for(let i=0;i<(r-2)/4;i++){const s=t.readString();n[s]=le(t,e)}return n}case 3:{const n=new Array((r-3)/4);e.push(n);for(let i=0;i<n.length;i++)n[i]=le(t,e);return n}}throw new Error("Unreachable code reached")}else if(r>=128){const n=new TextDecoder().decode(t.readBuffer(r-128)),i=$e.get(n);if(i)return i(t,e);throw new Error("Unknown data type: "+n)}else switch(String.fromCodePoint(r)){case"n":return null;case"t":return!0;case"f":return!1;case"i":return t.readInt();case"d":return t.readDouble();case"l":return t.readLong();case"b":return t.readBuffer(t.readLength());case"D":return new Date(Number(t.readLong()));case"R":{const c=t.readString(),o=t.readByte();return new RegExp(c,"g"+(o&1?"i":"")+(o&2?"m":""))}case"E":return t.readError();case"O":const n=t.readString();if(n==null)throw new Error("Type can't be null");return H(n);case"F":const i=t.readString();if(i==null)throw new Error("Type can't be null");const s=t.readString();if(s==null)throw new Error("Method can't be null");const a=new C(i,s);return e.push(a),a;default:throw new Error("Unknown data type number: "+r)}}function ue(t,e,r){if(e==null)t.writeLength(110);else if(e===!0)t.writeLength(116);else if(e===!1)t.writeLength(102);else if(typeof e=="number"&&(e|0)===e)t.writeLength(105),t.writeInt(e);else if(typeof e=="number")t.writeLength(100),t.writeDouble(e);else if(typeof e=="bigint")t.writeLength(108),t.writeLong(e);else if(e instanceof Uint8Array)t.writeLength(98),t.writeLength(e.length),t.writeBuffer(e);else if(e instanceof Date)t.writeLength(68),t.writeLong(+e);else if(e instanceof RegExp){t.writeLength(82),t.writeString(e.source);const n=e.flags;t.writeByte((n.includes("i")?1:0)||(n.includes("m")?2:0))}else if(e instanceof Error)t.writeLength(69),t.writeError(e);else if(typeof e=="object"&&O in e)t.writeLength(79),t.writeString(e[O]);else if(typeof e=="function"){r.push(e),t.writeLength(70);let n;e instanceof C?n=e:(n=re(e),Pe.set(e,()=>ne(n))),t.writeString(n.type),t.writeString(n.method)}else if(r.includes(e))t.writeLength(-(r.indexOf(e)*4));else if(typeof e=="string"){const n=new TextEncoder().encode(e);t.writeLength(-(n.length*4+1)),t.writeBytes(n)}else if(Array.isArray(e)){r.push(e),t.writeLength(-(e.length*4+3));for(let n of e)ue(t,n,r)}else{for(let[n,i,s]of xe){if(!i(e))continue;const a=new TextEncoder().encode(n);t.writeLength(a.length+128),t.writeBytes(a),s(t,e,r);return}if(typeof e=="object"){r.push(e);const n=Object.entries(e);t.writeLength(-(n.length*4+2));for(let[i,s]of n)t.writeString(i),ue(t,s,r)}else throw new Error("Unknown type for "+e)}}const Pe=new WeakMap;function Y(t){for(let e of t)Pe.get(e)?.()}class T{_buf;_data;_count=0;constructor(e=32){this._buf=typeof e=="number"?new Uint8Array(e):e,this._data=new DataView(this._buf.buffer)}ensureCapacity(e){if(e+=this._count,e>this._buf.byteLength){let r=new Uint8Array(Math.max(this._buf.byteLength*2,e));this._data=new DataView(r.buffer),r.set(this._buf),this._buf=r}}writeByte(e){this.ensureCapacity(1),this._buf[this._count]=e,this._count++}writeBytes(e){this.ensureCapacity(e.length),this._buf.set(e,this._count),this._count+=e.length}writeBuffer(e){this.writeBytes(e)}writeBoolean(e){this.writeByte(e?1:0)}writeNullBoolean(e){this.writeByte(e==null?2:e?1:0)}writeShort(e){this.ensureCapacity(2),this._data.setInt16(this._count,e),this._count+=2}writeChar(e){this.writeShort(e.charCodeAt(0))}writeInt(e){this.ensureCapacity(4),this._data.setInt32(this._count,e),this._count+=4}writeLong(e){typeof e=="number"?(this.writeInt(e/2**32),this.writeInt(e%2**32)):(this.writeInt(Number(e/BigInt(2**32))),this.writeInt(Number(e%BigInt(2**32))))}writeFloat(e){this.ensureCapacity(4),this._data.setFloat32(this._count,e),this._count+=4}writeDouble(e){this.ensureCapacity(8),this._data.setFloat64(this._count,e),this._count+=8}writeString(e){if(e==null){this.writeLength(-1);return}let r=new TextEncoder().encode(e);this.writeLength(r.length),this.writeBytes(r)}writeLength(e){let r=(e<0?~e:e)>>>0;for(;r>=128;)this.writeByte(r|128),r>>=7;e<0?(this.writeByte(r|128),this.writeByte(0)):this.writeByte(r)}writeByteArray(e){e?(this.writeLength(e.length),this.writeBytes(e)):this.writeLength(-1)}writeArray(e,r){if(!e)this.writeLength(-1);else{this.writeLength(e.length);for(let n=0;n<e.length;n++)r.call(this,e[n])}}toBuffer(e=0){return this._buf.slice(e,this._count-e)}writeError(e){try{throw m.wrapAndFreeze(e)}catch(r){r.write(this)}}writeDynamic(e,r=[]){ue(this,e,r)}}const S=new Map,P=new Map;function at(t){for(let e of S.values())E.get(e)?.(t);S.clear();for(let e of P.values())e.cancelSelf()}function I(t){if(B==null)throw exports.RpcConnectionError.new("Not connected");B.send(t.toBuffer())}function ct(t,e,r){S.set(t,e);try{I(r)}catch(n){E.get(e)?.(n)}}var Q=(t=>(t[t.FunctionCall=0]="FunctionCall",t[t.FunctionSuccess=1]="FunctionSuccess",t[t.FunctionError=2]="FunctionError",t[t.FunctionCancel=3]="FunctionCancel",t[t.MessageToExecutor=4]="MessageToExecutor",t[t.MessageToCaller=5]="MessageToCaller",t))(Q||{});async function lt(t){try{switch(t.readByte()){case 0:{const r=t.readLength(),n=[];let i=!1,s=null,a=null;const c=new Promise((o,w)=>{s=l=>{o(l),i=!0;const f=new T;f.writeByte(1),f.writeLength(r),f.writeDynamic(l),I(f),P.delete(r),Y(n)},a=l=>{w(l),i=!0;const f=new T;f.writeByte(2),f.writeLength(r),f.writeError(l),I(f),P.delete(r),Y(n)}});c.catch(()=>{});try{const o=t.readString();if(o==null)throw exports.RpcTypeNotFoundError.new(null);const w=_.get(o);if(!w)throw exports.RpcTypeNotFoundError.new(o);const l=t.readString(),f=t.readArray(()=>t.readDynamic(n))??[],h=new AbortController,g={type:o,method:l,get finished(){return i},promise:c,sendMessage(...p){if(i)return g;const u=new T;u.writeByte(5),u.writeLength(r);const d=[];return u.writeArray(p,v=>u.writeDynamic(v,d)),n.push(...d),I(u),g},addMessageListener(p){return V(g,p),g},cancelToken:h.signal,cancelSelf:()=>h.abort(),[Symbol.asyncIterator]:()=>z(g)};P.set(r,g),await Le(Me.bind(null,w,o,l,...f),g,s,a,o,l,f)}catch(o){a(o)}break}case 1:{const r=t.readLength(),n=S.get(r);if(n==null){console.warn(`${b.prettyName} has no activeRequest with id: ${r}`);break}try{k.get(n)?.(t.readDynamic())}catch(i){E.get(n)?.(i)}finally{S.delete(r)}break}case 2:{const r=t.readLength(),n=S.get(r);if(n==null){console.warn(`${b.prettyName} has no activeRequest with id: ${r}`);break}try{throw t.readError()}catch(i){E.get(n)?.(i)}finally{S.delete(r)}break}case 3:{const r=t.readLength();let n=P.get(r);if(!n){console.warn(`${b.prettyName} has no CurrentlyExecuting with id: ${r}`);break}n.cancelSelf();break}case 4:{const r=t.readLength();let n=P.get(r);if(!n){console.warn(`${b.prettyName} has no CurrentlyExecuting with id: ${r}`);break}const i=[],s=t.readArray(()=>t.readDynamic(i))??[];j(n,s);break}case 5:{const r=t.readLength();let n=S.get(r);if(!n){console.warn(`${b.prettyName} has no ActiveRequest with id: ${r}`);break}const i=[],s=t.readArray(()=>t.readDynamic(i))??[];j(n,s);break}}}catch(e){console.error(e)}}class de{_buf;_data;_pos;_count;constructor(e,r=0,n=e.length){this._buf=e,this._data=new DataView(e.buffer),this._pos=r,this._count=r+n}readFully(e,r=0,n=e.length){let i=this._pos;if(this._count-i<n)throw new RangeError("not enough bytes available to use readFully");for(let a=r;a<r+n;a++)e[a]=this._buf[i++];this._pos=i}skip(e){let r=this.available();return e<r&&(r=e<0?0:e),this._pos+=r,r}available(){return this._count-this._pos}readAll(){return this._buf.slice(this._pos,this._pos=this._count)}readBuffer(e){if(e>this.available())throw new RangeError;return this._buf.slice(this._pos,this._pos+=e)}readByte(){return this._data.getUint8(this._pos++)}readBoolean(){return this.readByte()!=0}readNullBoolean(){const e=this.readByte();return e<2?e==1:null}readShort(){const e=this._data.getInt16(this._pos);return this._pos+=2,e}readUShort(){const e=this._data.getUint16(this._pos);return this._pos+=2,e}readChar(){return String.fromCharCode(this.readUShort())}readInt(){const e=this._data.getInt32(this._pos);return this._pos+=4,e}readLong(){return BigInt(this.readInt())*BigInt(2**32)+BigInt(this.readInt()>>>0)}readFloat(){const e=this._data.getFloat32(this._pos);return this._pos+=4,e}readDouble(){const e=this._data.getFloat64(this._pos);return this._pos+=8,e}readString(){let e=this.readLength();return e==-1?null:new TextDecoder().decode(this.readBuffer(e))}readLength(){let e=0,r=0;for(;;){const n=this.readByte();if(n==0)return r==0?0:~e;if(!(n&128))return e|=n<<r,e;e|=(n&127)<<r,r+=7}}readArray(e){const r=this.readLength();if(r==-1)return null;const n=[];for(let i=0;i<r;i++)n[i]=e.call(this);return n}readError(){return m.read(this)}readDynamic(e=[]){return le(this,e)}}let x=!1,pe,fe,Z=new Promise((t,e)=>[pe,fe]=[t,e]);Z.catch(()=>{});async function ut(){for(;;)if(await Z.then(()=>!0,()=>!1))return}let A;if(Oe){const t="RPC_URL"in globalThis?globalThis.RPC_URL:process.env.RPC_URL,e="RPC_TOKEN"in globalThis?globalThis.RPC_TOKEN:process.env.RPC_TOKEN;t?A=async r=>{const n=new URL(t);return n.search=r.toString(),new(await import("ws")).WebSocket(n,e==null?{}:{headers:{Cookie:"RPC_TOKEN="+e}})}:(console.warn("RPC_URL is not defined => RPC will not connect"),A=async()=>({}))}else if("document"in globalThis)A=async t=>new WebSocket("ws"+document.location.origin.substring(4)+"/rpc?"+t);else{const t="RPC_URL"in globalThis?globalThis.RPC_URL:process.env.RPC_URL,e="RPC_TOKEN"in globalThis?globalThis.RPC_TOKEN:process.env.RPC_TOKEN;t?A=async r=>{const n=new URL(t);return n.search=r.toString(),new WebSocket(n,e==null?{}:{headers:{Cookie:"RPC_TOKEN="+e}})}:(console.warn("RPC_URL is not defined => RPC will not connect"),A=async()=>({}))}function _e(t){const e=fe;Z=new Promise((r,n)=>[pe,fe]=[r,n]),Z.catch(()=>{}),e(t),at(t)}let B=null;async function ft(t){let e=F,r=new Set;const n=new URLSearchParams;n.set("id",R),r.add("$"+R),e!=null&&n.set("name",e);for(let s of _.keys())r.has(s)||(r.add(s),n.append("type",s));const i=await A(n);i.onclose=()=>{setTimeout(t,1e3),B&&(B=null,x=!1,console.log("Reconnecting to RPC"),_e(exports.RpcConnectionError.new("Connection closed by "+b.prettyName)))},i.onopen=async()=>{console.log("Connected to RPC");try{B=i;const s=new Set(_.keys()),a=new Set(r);for(let c of s)a.delete(c)&&s.delete(c);s.size||a.size?F!=e?await y(null,"H",F,[...s.keys()],[...a.keys()]):await y(null,"H",[...s.keys()],[...a.keys()]):F!=e&&await y(null,"H",F),x=!0,pe()}catch(s){console.error("Error registering types: ",s),_e(s),i?.close(4e3,"Error registering types");return}},i.binaryType="arraybuffer",i.onmessage=s=>{const a=s.data;typeof a=="string"?console.log(a):lt(new de(new Uint8Array(a)))}}(async function(){for(await Promise.resolve();;)await new Promise(e=>ft(e))})();let F=null;async function ht(t){F=t;try{x&&await y(null,"N",t)}catch(e){console.error(e)}}function Ae(t){return function(e){xe.push([t,r=>r instanceof e,(r,n,i)=>n.write(r,i)]),$e.set(t,(r,n)=>e.read(r,n))}}function Ie(t){return function(e){Fe(t??e.prototype.constructor.name,e).catch(console.error)}}Promise.resolve().then(()=>gt).then(t=>Object.assign(globalThis,t));class b{static id=R;static get prettyName(){return b.name!=null?`${b.name} (${b.id})`:b.id}static get name(){return F}static setName=ht;static get isConnected(){return x}static get waitUntilConnected(){return ut()}static createObject=H;static createFunction=(e,r)=>new C(e,r);static registerFunction=re;static unregisterFunction=ne;static callLocal=st;static callFunction=y;static getContext=nt;static runWithContext=rt;static registerType=Fe;static unregisterType=tt;static getObjectWithFallback=async(e,...r)=>await y("Rpc","getObjectWithFallback",e,...r);static checkTypes=async(...e)=>await y("Rpc","checkTypes",...e);static checkType=async e=>await y("Rpc","checkType",e);static getAllTypes=async()=>await y("Rpc","getAllTypes");static getAllConnections=async()=>await y("Rpc","getAllConnections");static getRegistrations=async(e=!1)=>await y("Rpc","getRegistrations",e);static evalObject=async e=>await y("Rpc","evalObject",e);static evalString=async e=>await y("Rpc","evalString",e);static listenCalls=()=>y("Rpc","listenCalls");static root=ge;static type=O;static exists=G;static getMethods=D}const gt=Object.freeze(Object.defineProperty({__proto__:null,CustomDynamicType:Ae,DataInput:de,DataOutput:T,PendingCall:te,RPC_ROOT:ge,Rpc:b,RpcCallError:U,get RpcConnectionError(){return exports.RpcConnectionError},RpcCustomError:$,RpcError:m,get RpcEvalError(){return exports.RpcEvalError},RpcFunction:C,get RpcMetaMethodNotFoundError(){return exports.RpcMetaMethodNotFoundError},get RpcMethodNotFoundError(){return exports.RpcMethodNotFoundError},RpcObjectExists:G,RpcObjectGetMethods:D,RpcObjectType:O,RpcProvider:Ie,get RpcTypeNotFoundError(){return exports.RpcTypeNotFoundError},createRemoteObject:H,getAsyncIterator:z,listenersMap:L,pendingMap:M,registerFunction:re,registerReceive:V,rejectCall:E,resolveCall:k,runReceiveMessage:j,unregisterFunction:ne},Symbol.toStringTag,{value:"Module"}));exports.CustomDynamicType=Ae;exports.DataInput=de;exports.DataOutput=T;exports.PendingCall=te;exports.RPC_ROOT=ge;exports.Rpc=b;exports.RpcCallError=U;exports.RpcCustomError=$;exports.RpcError=m;exports.RpcFunction=C;exports.RpcObjectExists=G;exports.RpcObjectGetMethods=D;exports.RpcObjectType=O;exports.RpcProvider=Ie;exports.createRemoteObject=H;exports.getAsyncIterator=z;exports.listenersMap=L;exports.pendingMap=M;exports.registerFunction=re;exports.registerReceive=V;exports.rejectCall=E;exports.resolveCall=k;exports.runReceiveMessage=j;exports.unregisterFunction=ne;
//# sourceMappingURL=rpc.cjs.map
